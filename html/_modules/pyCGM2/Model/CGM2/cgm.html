<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyCGM2.Model.CGM2.cgm &#8212; pyCGM2-API 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/bootswatch-3.3.6/cosmo/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          pyCGM2-API</a>
        <span class="navbar-text navbar-version pull-left"><b>version 0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../https://pycgm2.github.io/index.html">pyCGM2</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts.html#nomenclature">Nomenclature</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../nexusApps.html">Nexus Applications</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../normativeData.html">Gait normative datasets</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyCGM2.html">pyCGM2 package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyCGM2.Model.CGM2.html">pyCGM2.Model.CGM2 subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyCGM2.Processing.html">pyCGM2.Processing subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyCGM2.Report.html">pyCGM2.Report subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyCGM2.Signal.html">pyCGM2.Signal subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyCGM2.Math.html">pyCGM2.Math subpackage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyCGM2.Tools.html">pyCGM2.Tools subpackage</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for pyCGM2.Model.CGM2.cgm</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pdb</span>

<span class="kn">import</span> <span class="nn">model</span> <span class="k">as</span> <span class="nn">cmb</span>
<span class="kn">import</span> <span class="nn">modelDecorator</span> <span class="k">as</span> <span class="nn">cmd</span>
<span class="kn">import</span> <span class="nn">frame</span> <span class="k">as</span> <span class="nn">cfr</span>
<span class="kn">import</span> <span class="nn">motion</span> <span class="k">as</span> <span class="nn">cmot</span>
<span class="kn">import</span> <span class="nn">euler</span> <span class="k">as</span> <span class="nn">ceuler</span>

<span class="kn">import</span> <span class="nn">pyCGM2.enums</span> <span class="k">as</span> <span class="nn">pyCGM2Enums</span>
<span class="kn">from</span> <span class="nn">pyCGM2.Math</span> <span class="k">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">pyCGM2.Tools</span> <span class="k">import</span>  <span class="n">btkTools</span>



<div class="viewcode-block" id="CGM"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM">[docs]</a><span class="k">class</span> <span class="nc">CGM</span><span class="p">(</span><span class="n">cmb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Abstract Class of the Conventional Gait Model</span>
<span class="sd">    &quot;&quot;&quot;</span> 

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CGM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">m_useLeftTibialTorsion</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_useRightTibialTorsion</span><span class="o">=</span><span class="kc">False</span>
        
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="CGM.hipJointCenters"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM.hipJointCenters">[docs]</a>    <span class="k">def</span> <span class="nf">hipJointCenters</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">mp_input</span><span class="p">,</span><span class="n">mp_computed</span><span class="p">,</span><span class="n">markerDiameter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Hip joint centre regression according Davis et al, 1991 </span>
<span class="sd">    </span>
<span class="sd">            :Parameters:</span>
<span class="sd">                - `mp_input` (dict) - dictionnary of anthropometric parameters inputed manually </span>
<span class="sd">                - `mp_computed` (dict) - dictionnary of anthropometric parameters computed automatically by the CGM processing</span>
<span class="sd">                - `markerDiameter` (double) - diameter of optoelectronic marker</span>

<span class="sd">            .. Danger:: Don t use a marker set with different diameters. </span>

<span class="sd">            **Reference**</span>

<span class="sd">            Davis, R., Ounpuu, S., Tyburski, D., &amp; Gage, J. (1991). A gait analysis data collection and reduction technique. Human Movement Science, 10, 575–587.    </span>

<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>        
        
        <span class="n">C</span><span class="o">=</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;MeanlegLength&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.115</span> <span class="o">-</span> <span class="mf">15.3</span>
        
        <span class="n">HJCx_L</span><span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.314</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftAsisTrocanterDistance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">markerDiameter</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.314</span><span class="p">)</span>
        <span class="n">HJCy_L</span><span class="o">=-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;InterAsisDistance&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>              
        <span class="n">HJCz_L</span><span class="o">=</span> <span class="o">-</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.314</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftAsisTrocanterDistance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">markerDiameter</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.314</span><span class="p">)</span>

        <span class="n">HJC_L</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">HJCx_L</span><span class="p">,</span><span class="n">HJCy_L</span><span class="p">,</span><span class="n">HJCz_L</span><span class="p">])</span>

        <span class="n">HJCx_R</span><span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.314</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightAsisTrocanterDistance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">markerDiameter</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.314</span><span class="p">)</span>
        <span class="n">HJCy_R</span><span class="o">=+</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;InterAsisDistance&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>              
        <span class="n">HJCz_R</span><span class="o">=</span> <span class="o">-</span><span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.314</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightAsisTrocanterDistance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">markerDiameter</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.314</span><span class="p">)</span>

        <span class="n">HJC_R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">HJCx_R</span><span class="p">,</span><span class="n">HJCy_R</span><span class="p">,</span><span class="n">HJCz_R</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">HJC_L</span><span class="p">,</span><span class="n">HJC_R</span></div>
    
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="CGM.chord"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM.chord">[docs]</a>    <span class="k">def</span> <span class="nf">chord</span> <span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Modified Chord method</span>
<span class="sd">            </span>
<span class="sd">            :Parameters:</span>
<span class="sd">                - `offset` (double) - offset to apply from the base point</span>
<span class="sd">                - `I` (double) - base point</span>
<span class="sd">                - `J` (double) - top point  </span>
<span class="sd">                - `K` (double) - lateral point</span>
<span class="sd">                - `beta` (double) - angle offset </span>
<span class="sd">                </span>
<span class="sd">            .. note:: For locating Knee Joint centre, native CGM uses I=KNE, J=HJC and K=THI and offset = knee radius         </span>
<span class="sd">        </span>
<span class="sd">            **Reference**</span>
<span class="sd">            </span>
<span class="sd">            Kabada, M., Ramakrishan, H., &amp; Wooten, M. (1990). Measurement of lower extremity kinematics during level walking. Journal of Orthopaedic Research, 8, 383–392. </span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>        
 
        <span class="k">if</span> <span class="n">beta</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="n">J</span><span class="o">-</span><span class="n">I</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">J</span><span class="o">-</span><span class="n">I</span><span class="p">)</span>
            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">K</span><span class="o">-</span><span class="n">I</span><span class="p">)</span>
            <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    
            <span class="n">matR</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ori</span><span class="o">=</span><span class="p">(</span><span class="n">J</span><span class="o">+</span><span class="n">I</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
            
            <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">J</span><span class="p">)</span>
            <span class="n">theta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">offset</span><span class="o">/</span><span class="n">d</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span>
            <span class="n">v_r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            
            <span class="n">rot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span> <span class="p">])</span>
            
           
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matR</span><span class="p">,</span><span class="n">rot</span><span class="p">),</span><span class="n">v_r</span><span class="p">)</span><span class="o">+</span><span class="n">ori</span>    

        <span class="k">else</span><span class="p">:</span>
 
            <span class="n">A</span><span class="o">=</span><span class="n">J</span>
            <span class="n">B</span><span class="o">=</span><span class="n">I</span>
            <span class="n">C</span><span class="o">=</span><span class="n">K</span>
            <span class="n">L</span><span class="o">=</span><span class="n">offset</span>
        
        
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.00000001</span>
                    
        
            <span class="n">AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="n">B</span><span class="p">)</span> 
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">AB</span><span class="p">)</span>
            <span class="n">AO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">AB</span><span class="o">*</span><span class="n">AB</span><span class="o">-</span><span class="n">L</span><span class="o">*</span><span class="n">L</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)))</span>
            
            <span class="c1"># chord avec beta nul</span>
            <span class="c1">#P = chord(L,B,A,C,beta=0.0) # attention ma methode . attention au arg input</span>
            
            <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="n">J</span><span class="o">-</span><span class="n">I</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">J</span><span class="o">-</span><span class="n">I</span><span class="p">)</span>
            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">K</span><span class="o">-</span><span class="n">I</span><span class="p">)</span>
            <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    
            <span class="n">matR</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ori</span><span class="o">=</span><span class="p">(</span><span class="n">J</span><span class="o">+</span><span class="n">I</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
            
            <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">J</span><span class="p">)</span>
            <span class="n">theta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">offset</span><span class="o">/</span><span class="n">d</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span>
            <span class="n">v_r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            
            <span class="n">rot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span> <span class="p">])</span>
            
           
            <span class="n">P</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matR</span><span class="p">,</span><span class="n">rot</span><span class="p">),</span><span class="n">v_r</span><span class="p">)</span><span class="o">+</span><span class="n">ori</span> 
            <span class="c1"># fin chord 0</span>
                 
        
            <span class="n">Salpha</span> <span class="o">=</span> <span class="mi">0</span>            
            <span class="n">diffBeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
            <span class="n">alphaincr</span> <span class="o">=</span> <span class="n">beta</span> <span class="c1"># in degree</span>
                        
        
            <span class="c1"># define P research circle in T plan</span>
            <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="n">B</span><span class="p">)</span><span class="o">/</span><span class="n">AB</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">AO</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">L</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="c1">#OK</span>
        
        
            <span class="c1"># build segment</span>
            <span class="c1">#T = BuildSegment(O,n,P-O,&#39;zyx&#39;);</span>
            <span class="n">Z</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">Y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">P</span><span class="o">-</span><span class="n">O</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">P</span><span class="o">-</span><span class="n">O</span><span class="p">))</span>
            <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>
            <span class="n">Origin</span><span class="o">=</span> <span class="n">O</span>
            
            <span class="c1"># erreur ici, il manque les norm</span>
            <span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">],</span>
                        <span class="p">[</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">],</span>
                        <span class="p">[</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">],</span>
                        <span class="p">[</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>       <span class="mf">1.0</span>  <span class="p">]])</span>
        
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">diffBeta</span> <span class="o">&gt;</span> <span class="n">eps</span> <span class="ow">or</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;count boubdary achieve&quot;</span><span class="p">)</span>

                        	
                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span> 
                <span class="n">idiff</span> <span class="o">=</span> <span class="n">diffBeta</span>
                
                <span class="n">Salpha</span> <span class="o">=</span> <span class="n">Salpha</span> <span class="o">+</span> <span class="n">alphaincr</span>
                <span class="n">Salpharad</span> <span class="o">=</span> <span class="n">Salpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
                <span class="n">Pplan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>  <span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Salpharad</span><span class="p">)],</span>
                                    <span class="p">[</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Salpharad</span><span class="p">)],</span>
                                     <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">Pplan</span><span class="p">)</span>
        
                <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nBone</span> <span class="o">=</span> <span class="n">A</span><span class="o">-</span><span class="n">P</span>
        
                <span class="n">ProjC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nBone</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">C</span><span class="o">-</span><span class="n">P</span><span class="p">,</span><span class="n">nBone</span><span class="p">))</span>
                <span class="n">ProjB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nBone</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">B</span><span class="o">-</span><span class="n">P</span><span class="p">,</span><span class="n">nBone</span><span class="p">))</span>                
        
                
                <span class="n">sens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ProjC</span><span class="p">,</span><span class="n">ProjB</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">nBone</span><span class="p">)</span>
            
        
                
                <span class="n">Betai</span> <span class="o">=</span> <span class="n">sens</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sens</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ProjC</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ProjB</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ProjC</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ProjB</span><span class="p">)))</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                
                <span class="n">diffBeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">Betai</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">diffBeta</span> <span class="o">-</span> <span class="n">idiff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">Salpha</span> <span class="o">=</span> <span class="n">Salpha</span> <span class="o">-</span> <span class="n">alphaincr</span>
                        <span class="n">alphaincr</span> <span class="o">=</span> <span class="o">-</span><span class="n">alphaincr</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">alphaincr</span> <span class="o">=</span> <span class="o">-</span><span class="n">alphaincr</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
                        
        
            <span class="k">return</span> <span class="n">P</span>  </div>

<div class="viewcode-block" id="CGM.displayStaticCoordinateSystem"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM.displayStaticCoordinateSystem">[docs]</a>    <span class="k">def</span> <span class="nf">displayStaticCoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span>  <span class="n">segmentLabel</span><span class="p">,</span> <span class="n">targetPointLabel</span><span class="p">,</span> <span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Display a coordinate system. Its Axis are represented by 3 virtual markers suffixed by (_X,_Y,_Z)</span>
<span class="sd">            </span>
<span class="sd">            :Parameters:</span>
<span class="sd">                - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">                - `segmentLabel` (str) - segment label</span>
<span class="sd">                - `targetPointLabel` (str) - label of the point defining axis limits</span>
<span class="sd">                - `referential` (str) - type of segment coordinate system you want dislay ( if other than *Anatomic*, Technical Coordinate system will be displayed ) </span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="n">segmentLabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">referential</span> <span class="o">==</span> <span class="s2">&quot;Anatomic&quot;</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span> 
       
        <span class="n">val</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="n">targetPointLabel</span><span class="o">+</span><span class="s2">&quot;_X&quot;</span><span class="p">,</span><span class="n">val</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">)),</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="n">targetPointLabel</span><span class="o">+</span><span class="s2">&quot;_Y&quot;</span><span class="p">,</span><span class="n">val</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">)),</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="n">targetPointLabel</span><span class="o">+</span><span class="s2">&quot;_Z&quot;</span><span class="p">,</span><span class="n">val</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">)),</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">displayMotionCoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">acqui</span><span class="p">,</span>  <span class="n">segmentLabel</span><span class="p">,</span> <span class="n">targetPointLabel</span><span class="p">,</span> <span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span> <span class="p">):</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="n">segmentLabel</span><span class="p">)</span>
        <span class="n">valX</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">valY</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">valZ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>        
        
        
        <span class="k">if</span> <span class="n">referential</span> <span class="o">==</span> <span class="s2">&quot;Anatomic&quot;</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>    
            <span class="n">valX</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
            <span class="n">valY</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
            <span class="n">valZ</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>       
       
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">acqui</span><span class="p">,</span><span class="n">targetPointLabel</span><span class="o">+</span><span class="s2">&quot;_X&quot;</span><span class="p">,</span><span class="n">valX</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">acqui</span><span class="p">,</span><span class="n">targetPointLabel</span><span class="o">+</span><span class="s2">&quot;_Y&quot;</span><span class="p">,</span><span class="n">valY</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">acqui</span><span class="p">,</span><span class="n">targetPointLabel</span><span class="o">+</span><span class="s2">&quot;_Z&quot;</span><span class="p">,</span><span class="n">valZ</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">acqui</span><span class="p">,</span>  <span class="n">segmentLabel</span><span class="p">,</span><span class="n">targetPointLabelO</span><span class="p">,</span><span class="n">targetPointLabelX</span><span class="p">,</span><span class="n">targetPointLabelY</span><span class="p">,</span><span class="n">targetPointLabelZ</span><span class="p">,</span> <span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span> <span class="p">):</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="n">segmentLabel</span><span class="p">)</span>
        
        <span class="n">origin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">valX</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">valY</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">valZ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>        
        
        
        <span class="k">if</span> <span class="n">referential</span> <span class="o">==</span> <span class="s2">&quot;Anatomic&quot;</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">acqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>    
            <span class="n">origin</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
            <span class="n">valX</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
            <span class="n">valY</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>
            <span class="n">valZ</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span>       
       
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">acqui</span><span class="p">,</span><span class="n">targetPointLabelO</span><span class="p">,</span><span class="n">origin</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>   
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">acqui</span><span class="p">,</span><span class="n">targetPointLabelX</span><span class="p">,</span><span class="n">valX</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">acqui</span><span class="p">,</span><span class="n">targetPointLabelY</span><span class="p">,</span><span class="n">valY</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">acqui</span><span class="p">,</span><span class="n">targetPointLabelZ</span><span class="p">,</span><span class="n">valZ</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CGM1ModelInf"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf">[docs]</a><span class="k">class</span> <span class="nc">CGM1ModelInf</span><span class="p">(</span><span class="n">CGM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Lower limb conventional Gait Model 1 (i.e. Vicon Plugin Gait)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nativeCgm1</span> <span class="o">=</span> <span class="kc">True</span>        
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CGM1ModelInf</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoratedModel</span> <span class="o">=</span> <span class="kc">False</span>
        

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;LowerLimb CGM1&quot;</span>        
    
    <span class="nd">@classmethod</span>    
<div class="viewcode-block" id="CGM1ModelInf.cleanAcquisition"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.cleanAcquisition">[docs]</a>    <span class="k">def</span> <span class="nf">cleanAcquisition</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">subjetPrefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">removelateralKnee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kadEnable</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ankleMedEnable</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convenient class for cleaning an acquisition and keeping CGM1 markers only.</span>
<span class="sd">            </span>
<span class="sd">            :Parameters:</span>
<span class="sd">                - `acq` (btkAcquisition) - btkAcquisition instance from a  c3d</span>
<span class="sd">                - `subjetPrefix` (str) - prefix identifying a subjet ( ex : hannibal:) </span>
<span class="sd">                - `removelateralKnee` (bool) - remove lateral knee marker (True if you deal with a static KAD acquisition)</span>
<span class="sd">                - `kadEnable` (bool) - keep KAD markers</span>
<span class="sd">                - `ankleMedEnable` (bool) -keep medial ankle markers</span>

<span class="sd">            .. note:: With Vicon Nexus, subject name prefixed marker label if you selected different subjets ( mean vsk) within your session</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LASI&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RASI&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LPSI&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RPSI&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LTHI&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LKNE&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LTIB&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LANK&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LHEE&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LTOE&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RTHI&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RKNE&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RTIB&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RANK&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RHEE&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RTOE&quot;</span><span class="p">,</span>
                   <span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;SACR&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">removelateralKnee</span><span class="p">:</span>
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LKNE&quot;</span><span class="p">)</span>                  
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RKNE&quot;</span><span class="p">)</span>                  


        <span class="k">if</span> <span class="n">kadEnable</span><span class="p">:</span>
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LKAX&quot;</span><span class="p">)</span>                  
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LKD1&quot;</span><span class="p">)</span>                  
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LKD2&quot;</span><span class="p">)</span>                                     
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RKAX&quot;</span><span class="p">)</span>                  
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RKD1&quot;</span><span class="p">)</span>                  
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RKD2&quot;</span><span class="p">)</span>                                     

        <span class="k">if</span> <span class="n">ankleMedEnable</span><span class="p">:</span>
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;LMED&quot;</span><span class="p">)</span>   
            <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subjetPrefix</span><span class="o">+</span><span class="s2">&quot;RMED&quot;</span><span class="p">)</span>   

                   
        <span class="n">btkTools</span><span class="o">.</span><span class="n">clearPoints</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span><span class="n">markers</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">acq</span></div>


<div class="viewcode-block" id="CGM1ModelInf.configure"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Model configuration. Define Segment, joint, ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
            
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Central</span><span class="p">,[</span><span class="s2">&quot;LASI&quot;</span><span class="p">,</span><span class="s2">&quot;RASI&quot;</span><span class="p">,</span><span class="s2">&quot;LPSI&quot;</span><span class="p">,</span><span class="s2">&quot;RPSI&quot;</span><span class="p">],</span> <span class="n">tracking_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LASI&quot;</span><span class="p">,</span><span class="s2">&quot;RASI&quot;</span><span class="p">,</span><span class="s2">&quot;LPSI&quot;</span><span class="p">,</span><span class="s2">&quot;RPSI&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Left</span><span class="p">,[</span><span class="s2">&quot;LKNE&quot;</span><span class="p">,</span><span class="s2">&quot;LTHI&quot;</span><span class="p">],</span> <span class="n">tracking_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LKNE&quot;</span><span class="p">,</span><span class="s2">&quot;LTHI&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Right</span><span class="p">,[</span><span class="s2">&quot;RKNE&quot;</span><span class="p">,</span><span class="s2">&quot;RTHI&quot;</span><span class="p">],</span> <span class="n">tracking_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RKNE&quot;</span><span class="p">,</span><span class="s2">&quot;RTHI&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Left</span><span class="p">,[</span><span class="s2">&quot;LANK&quot;</span><span class="p">,</span><span class="s2">&quot;LTIB&quot;</span><span class="p">],</span> <span class="n">tracking_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LANK&quot;</span><span class="p">,</span><span class="s2">&quot;LTIB&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank Proximal&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span> <span class="c1"># copy of Left Shank with anatomical frame modified by a tibial Rotation Value ( see calibration)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Right</span><span class="p">,[</span><span class="s2">&quot;RANK&quot;</span><span class="p">,</span><span class="s2">&quot;RTIB&quot;</span><span class="p">],</span> <span class="n">tracking_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RANK&quot;</span><span class="p">,</span><span class="s2">&quot;RTIB&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank Proximal&quot;</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>        <span class="c1"># copy of Left Shank with anatomical frame modified by a tibial Rotation Value ( see calibration)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Left</span><span class="p">,[</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="s2">&quot;LHEE&quot;</span><span class="p">,</span><span class="s2">&quot;LTOE&quot;</span><span class="p">],</span> <span class="n">tracking_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LHEE&quot;</span><span class="p">,</span><span class="s2">&quot;LTOE&quot;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSegment</span><span class="p">(</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">SegmentSide</span><span class="o">.</span><span class="n">Right</span><span class="p">,[</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="s2">&quot;RHEE&quot;</span><span class="p">,</span><span class="s2">&quot;RTOE&quot;</span><span class="p">],</span> <span class="n">tracking_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RHEE&quot;</span><span class="p">,</span><span class="s2">&quot;RTOE&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addChain</span><span class="p">(</span><span class="s2">&quot;Left Lower Limb&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># Dist -&gt;Prox Todo Improve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addChain</span><span class="p">(</span><span class="s2">&quot;Right Lower Limb&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addJoint</span><span class="p">(</span><span class="s2">&quot;LHip&quot;</span><span class="p">,</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">,</span> <span class="s2">&quot;Left Thigh&quot;</span><span class="p">,</span><span class="s2">&quot;YXZ&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addJoint</span><span class="p">(</span><span class="s2">&quot;LKnee&quot;</span><span class="p">,</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">,</span> <span class="s2">&quot;Left Shank Proximal&quot;</span><span class="p">,</span><span class="s2">&quot;YXZ&quot;</span><span class="p">)</span>
        <span class="c1">#self.addJoint(&quot;LKneeAngles_cgm&quot;,&quot;Left Thigh&quot;, &quot;Left Shank&quot;,&quot;YXZ&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addJoint</span><span class="p">(</span><span class="s2">&quot;LAnkle&quot;</span><span class="p">,</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">,</span> <span class="s2">&quot;Left Foot&quot;</span><span class="p">,</span><span class="s2">&quot;YXZ&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">addJoint</span><span class="p">(</span><span class="s2">&quot;RHip&quot;</span><span class="p">,</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">,</span> <span class="s2">&quot;Right Thigh&quot;</span><span class="p">,</span><span class="s2">&quot;YXZ&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addJoint</span><span class="p">(</span><span class="s2">&quot;RKnee&quot;</span><span class="p">,</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">,</span> <span class="s2">&quot;Right Shank Proximal&quot;</span><span class="p">,</span><span class="s2">&quot;YXZ&quot;</span><span class="p">)</span>
        <span class="c1">#self.addJoint(&quot;RKneeAngles_cgm&quot;,&quot;Right Thigh&quot;, &quot;Right Shank&quot;,&quot;YXZ&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addJoint</span><span class="p">(</span><span class="s2">&quot;RAnkle&quot;</span><span class="p">,</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">,</span> <span class="s2">&quot;Right Foot&quot;</span><span class="p">,</span><span class="s2">&quot;YXZ&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CGM1ModelInf.calibrationProcedure"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.calibrationProcedure">[docs]</a>    <span class="k">def</span> <span class="nf">calibrationProcedure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Define the calibration Procedure</span>

<span class="sd">            :Return:</span>
<span class="sd">                - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system  </span>
<span class="sd">                - `dictRefAnatomical` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system  </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dictRef</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;YZX&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;RASI&quot;</span><span class="p">,</span><span class="s2">&quot;LASI&quot;</span><span class="p">,</span><span class="s2">&quot;SACR&quot;</span><span class="p">,</span><span class="s2">&quot;midASIS&quot;</span><span class="p">]}</span> <span class="p">}</span>
        <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXiY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;LKNE&quot;</span><span class="p">,</span><span class="s2">&quot;LHJC&quot;</span><span class="p">,</span><span class="s2">&quot;LTHI&quot;</span><span class="p">,</span><span class="s2">&quot;LKNE&quot;</span><span class="p">]}</span> <span class="p">}</span>
        <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;RKNE&quot;</span><span class="p">,</span><span class="s2">&quot;RHJC&quot;</span><span class="p">,</span><span class="s2">&quot;RTHI&quot;</span><span class="p">,</span><span class="s2">&quot;RKNE&quot;</span><span class="p">]}</span> <span class="p">}</span>
        <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXiY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;LANK&quot;</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="s2">&quot;LTIB&quot;</span><span class="p">,</span><span class="s2">&quot;LANK&quot;</span><span class="p">]}</span> <span class="p">}</span>
        <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;RANK&quot;</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="s2">&quot;RTIB&quot;</span><span class="p">,</span><span class="s2">&quot;RANK&quot;</span><span class="p">]}</span> <span class="p">}</span>
        
        <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXiY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;LTOE&quot;</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">]}</span> <span class="p">}</span> <span class="c1"># uncorrected Foot - use shank flexion axis (Y) as second axis</span>
        <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXiY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;RTOE&quot;</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">]}</span> <span class="p">}</span> <span class="c1"># uncorrected Foot - use shank flexion axis (Y) as second axis         </span>


        <span class="n">dictRefAnatomical</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">dictRefAnatomical</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;YZX&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;RASI&quot;</span><span class="p">,</span><span class="s2">&quot;LASI&quot;</span><span class="p">,</span><span class="s2">&quot;SACR&quot;</span><span class="p">,</span><span class="s2">&quot;midASIS&quot;</span><span class="p">]}</span> <span class="c1"># normaly : midHJC</span>
        <span class="n">dictRefAnatomical</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXiY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="s2">&quot;LHJC&quot;</span><span class="p">,</span><span class="s2">&quot;LKNE&quot;</span><span class="p">,</span><span class="s2">&quot;LHJC&quot;</span><span class="p">]}</span> <span class="c1"># origin = Proximal ( differ from native)</span>
        <span class="n">dictRefAnatomical</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="s2">&quot;RHJC&quot;</span><span class="p">,</span><span class="s2">&quot;RKNE&quot;</span><span class="p">,</span><span class="s2">&quot;RHJC&quot;</span><span class="p">]}</span> 
        <span class="n">dictRefAnatomical</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXiY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="s2">&quot;LANK&quot;</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">]}</span> 
        <span class="n">dictRefAnatomical</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="s2">&quot;RANK&quot;</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">]}</span>

        <span class="n">dictRefAnatomical</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXiY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;LTOE&quot;</span><span class="p">,</span><span class="s2">&quot;LHEE&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">]}</span>    <span class="c1"># corrected foot      </span>
        <span class="n">dictRefAnatomical</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZXiY&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;RTOE&quot;</span><span class="p">,</span><span class="s2">&quot;RHEE&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">]}</span>    <span class="c1"># corrected foot</span>

        
        <span class="k">return</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictRefAnatomical</span></div>

            

<div class="viewcode-block" id="CGM1ModelInf.calibrate"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.calibrate">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span>  <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Perform full CGM1 calibration. </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building **Technical** coordinate system</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building **Anatomical**  coordinate system </span>
<span class="sd">               - `options` (dict) - use to pass options, like options altering the standard segment construction.</span>
<span class="sd">               </span>
<span class="sd">            .. note:: This method constructs technical and anatomical frane sucessively.</span>

<span class="sd">            .. warning : Foot Calibration need attention. Indeed, its technical coordinate system builder requires the anatomical coordinate system of the shank                    </span>
<span class="sd">               </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO : to input Frane init and Frame end manually          </span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=====================================================&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;===================CGM CALIBRATION===================&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=====================================================&quot;</span><span class="p">)</span>        
        
        <span class="n">ff</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetFirstFrame</span><span class="p">()</span> 
        <span class="n">lf</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetLastFrame</span><span class="p">()</span>
        <span class="n">frameInit</span><span class="o">=</span><span class="n">ff</span><span class="o">-</span><span class="n">ff</span>  
        <span class="n">frameEnd</span><span class="o">=</span><span class="n">lf</span><span class="o">-</span><span class="n">ff</span><span class="o">+</span><span class="mi">1</span>         
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoratedModel</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; Native CGM&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">btkTools</span><span class="o">.</span><span class="n">isPointExist</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LKNE&quot;</span><span class="p">):</span>
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LKNE&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">)</span> <span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">btkTools</span><span class="o">.</span><span class="n">isPointExist</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RKNE&quot;</span><span class="p">):</span>
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RKNE&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">)</span> <span class="p">))</span>                

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; Decorated CGM&quot;</span><span class="p">)</span>
        
        <span class="c1"># ---- Pelvis-THIGH-SHANK CALIBRATION</span>
        <span class="c1">#-------------------------------------</span>
        <span class="c1"># calibration of technical Referentials</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Pelvis - TF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -------------------------------&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_pelvis_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Left Thigh- TF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ----------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_left_thigh_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Right Thigh - TF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ------------------------------------&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_right_thigh_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Left Shank - TF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -----------------------------------&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_left_shank_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        
        
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Richt Shank - TF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ------------------------------------&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_right_shank_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        

        <span class="c1"># calibration of anatomical Referentials</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Pelvis - AF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -------------------------------&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_pelvis_Anatomicalcalibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Pelvis&quot;</span><span class="p">,</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Left Thigh - AF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -----------------------------------&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_left_thigh_Anatomicalcalibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Left Thigh&quot;</span><span class="p">,</span><span class="s2">&quot;LThigh&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>


        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Right Thigh - AF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ------------------------------------&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_right_thigh_Anatomicalcalibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Right Thigh&quot;</span><span class="p">,</span><span class="s2">&quot;RThigh&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>  


        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Thigh Offsets ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --------------------&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;LeftThighRotation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftThighRotation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftThighRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftThighRotation&quot;</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getThighOffset</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;RightThighRotation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightThighRotation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightThighRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightThighRotation&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getThighOffset</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        


        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Left Shank - AF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_left_shank_Anatomicalcalibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Left Shank&quot;</span><span class="p">,</span><span class="s2">&quot;LShank&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>
        
        
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Right Shank - AF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -------------------------------&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_right_shank_Anatomicalcalibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">)</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Right Shank&quot;</span><span class="p">,</span><span class="s2">&quot;RShank&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>


        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ---Shank  Offsets ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ---------------------&quot;</span><span class="p">)</span>

        <span class="c1"># shakRotation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;LeftShankRotation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftShankRotation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftShankRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftShankRotation&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">getShankOffsets</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;RightShankRotation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightShankRotation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightShankRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightShankRotation&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">getShankOffsets</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

        <span class="c1"># tibial Torsion</span>
        <span class="c1">#   left</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;LeftTibialTorsion&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsion&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsionOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsion&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_useLeftTibialTorsion</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_useLeftTibialTorsion</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getTibialTorsionOffset</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsionOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span>
                
        <span class="c1">#   right</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;RightTibialTorsion&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsion&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsionOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsion&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_useRightTibialTorsion</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_useRightTibialTorsion</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getTibialTorsionOffset</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsionOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span>


        <span class="c1"># AbdAdd offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getAbdAddAnkleJointOffset</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getAbdAddAnkleJointOffset</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Left Shank Proximal- AF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -------------------------------------------&quot;</span><span class="p">)</span>
        <span class="c1">#   shank Prox ( copy )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateSegmentFromCopy</span><span class="p">(</span><span class="s2">&quot;Left Shank Proximal&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">))</span> <span class="c1"># look out . I copied the shank instance and rename it </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_left_shankProximal_AnatomicalCalibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span> <span class="c1"># alter static Frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Left Shank Proximal&quot;</span><span class="p">,</span><span class="s2">&quot;LShankProx&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>        

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Right Shank Proximal- AF calibration ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --------------------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateSegmentFromCopy</span><span class="p">(</span><span class="s2">&quot;Right Shank Proximal&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">))</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_right_shankProximal_AnatomicalCalibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span> <span class="c1"># alter static Frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Right Shank Proximal&quot;</span><span class="p">,</span><span class="s2">&quot;RShankProx&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>
        
        
        <span class="c1"># ---- FOOT CALIBRATION</span>
        <span class="c1">#-------------------------------------</span>
        <span class="c1"># foot ( need  Y-axis of the shank anatomic Frame)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Left Foot - TF calibration (uncorrected) ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -------------------------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_left_unCorrectedFoot_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Left Foot&quot;</span><span class="p">,</span><span class="s2">&quot;LFootUncorrected&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;technic&quot;</span>  <span class="p">)</span>  

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Left Foot - AF calibration (corrected) ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ----------------------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_left_foot_corrected_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Left Foot&quot;</span><span class="p">,</span><span class="s2">&quot;LFoot&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>              


        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Right Foot - TF calibration (uncorrected) ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -------------------------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_right_unCorrectedFoot_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Right Foot&quot;</span><span class="p">,</span><span class="s2">&quot;RFootUncorrected&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;technic&quot;</span>  <span class="p">)</span>              

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Right Foot - AF calibration (corrected) ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -----------------------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_right_foot_corrected_calibrate</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayStaticCoordinateSystem</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="p">,</span> <span class="s2">&quot;Right Foot&quot;</span><span class="p">,</span><span class="s2">&quot;RFoot&quot;</span><span class="p">,</span><span class="n">referential</span> <span class="o">=</span> <span class="s2">&quot;Anatomic&quot;</span>  <span class="p">)</span>      
 
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --- Foot Offsets ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getFootOffset</span><span class="p">(</span><span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span> </div>

  
    <span class="c1"># ---- Technical Referential Calibration    </span>
    <span class="k">def</span> <span class="nf">_pelvis_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Technical Coordinate system of the pelvis. </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical referentials </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">               - `options` (dict) - use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>             
        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 

        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span> 

        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">)</span>

        <span class="c1"># ---  additional markers and Update of the marker segment list</span>

        <span class="c1"># new markers</span>
        <span class="n">valSACR</span><span class="o">=</span><span class="p">(</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LPSI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span> <span class="o">+</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RPSI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>        
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;SACR&quot;</span><span class="p">,</span><span class="n">valSACR</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>        

        <span class="n">valMidAsis</span><span class="o">=</span><span class="p">(</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LASI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span> <span class="o">+</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RASI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>        
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;midASIS&quot;</span><span class="p">,</span><span class="n">valMidAsis</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>        

        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;SACR&quot;</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;midASIS&quot;</span><span class="p">)</span>
            
        <span class="c1"># new mp    </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;PelvisDepth&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;PelvisDepth&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PelvisDepth defined from your vsk file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;PelvisDepth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;PelvisDepth&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Pelvis Depth computed and added to model parameters&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;PelvisDepth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span> <span class="n">valMidAsis</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">valSACR</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span> <span class="p">(</span><span class="n">markerDiameter</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span> <span class="p">(</span><span class="n">basePlate</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;InterAsisDistance&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;InterAsisDistance&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;InterAsisDistance defined from your vsk file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;InterAsisDistance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;InterAsisDistance&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asisDistance computed and added to model parameters&quot;</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;InterAsisDistance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LASI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RASI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>



        <span class="c1"># --- Construction of the technical referential   </span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>

        <span class="c1">#   referential construction</span>
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>


        <span class="c1"># --- Hip Joint centers location </span>
        <span class="c1"># anthropometric parameter computed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;LeftAsisTrocanterDistance&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftAsisTrocanterDistance&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LeftAsisTrocanterDistance defined from your vsk file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s1">&#39;LeftAsisTrocanterDistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftAsisTrocanterDistance&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s1">&#39;LeftAsisTrocanterDistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1288</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;LeftLegLength&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">48.56</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;RightAsisTrocanterDistance&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightAsisTrocanterDistance&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RightAsisTrocanterDistance defined from your vsk file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s1">&#39;RightAsisTrocanterDistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightAsisTrocanterDistance&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s1">&#39;RightAsisTrocanterDistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1288</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;RightLegLength&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">48.56</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s1">&#39;MeanlegLength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;LeftLegLength&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;RightLegLength&#39;</span><span class="p">]</span> <span class="p">])</span>

        <span class="c1"># local Position of the hip joint centers</span>
                
        <span class="n">LHJC_loc</span><span class="p">,</span><span class="n">RHJC_loc</span><span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">hipJointCenters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">,</span><span class="n">markerDiameter</span><span class="p">)</span>

        <span class="c1"># --- nodes manager</span>
        <span class="c1"># add HJC</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;LHJC_cgm1&quot;</span><span class="p">,</span><span class="n">LHJC_loc</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Local&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;RHJC_cgm1&quot;</span><span class="p">,</span><span class="n">RHJC_loc</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Local&quot;</span><span class="p">)</span>

        <span class="c1"># add all point in the list</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>


        <span class="c1"># --- Btk Points and decorator manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoratedModel</span><span class="p">:</span>
            <span class="c1"># native : btkpoints LHJC and RHJC append with description cgm1-- &quot;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LHJC_cgm1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>      
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LHJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span> 

            <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RHJC_cgm1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>      
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RHJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># native : btkpoints LHJC_cgm1 and RHJC_cgm1 append with description cgm1-- &quot;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LHJC_cgm1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LHJC_cgm1&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>        
                        
            <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RHJC_cgm1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>      
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RHJC_cgm1&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s2">&quot;useLeftHJCnode&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (useLeftHJCnode) found &quot;</span><span class="p">)</span>

                <span class="n">nodeLabel</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useLeftHJCnode&quot;</span><span class="p">]</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span>
                 
                <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>      
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LHJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; no option (useLeftHJCnode) found = &gt; Left HJC comes from CGM1&quot;</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LHJC_cgm1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LHJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>                
                
            
            <span class="k">if</span> <span class="s2">&quot;useRightHJCnode&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (useRightHJCnode) found &quot;</span><span class="p">)</span>                  

                <span class="n">nodeLabel</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useRightHJCnode&quot;</span><span class="p">]</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span>

                <span class="c1"># construction of the btkPoint label (RHJC)                </span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>      
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RHJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; no option (useLeftHJCnode) found = &gt; Left HJC comes from CGM1&quot;</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RHJC_cgm1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RHJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>                  
        
        <span class="c1"># ---- final HJCs and mid point</span>
        <span class="n">final_LHJC</span> <span class="o">=</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">,</span><span class="n">final_LHJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="n">final_RHJC</span> <span class="o">=</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">,</span><span class="n">final_RHJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span>   
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span>   

        <span class="n">val</span><span class="o">=</span><span class="p">(</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span> <span class="o">+</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>        
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;midHJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_left_thigh_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Technical Coordinate system of the left thigh. </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical referentials</span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame               </span>
<span class="sd">               - `options` (dict) - use to pass options</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 

        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>             
            
        <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span>


        <span class="c1"># ---  additional markers and Update of the marker segment list</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span>        

        <span class="c1"># --- Construction of the technical referential </span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>       
        
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- knee Joint centers location from chord method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;LeftThighRotation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftThighRotation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LeftThighRotation defined from your vsk file&quot;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftThighRotationOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftThighRotation&quot;</span><span class="p">]</span><span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftThighRotationOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">LKJC</span> <span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">chord</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftKneeWidth&quot;</span><span class="p">]</span><span class="o">+</span> <span class="n">markerDiameter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftThighRotationOffset&quot;</span><span class="p">]</span> <span class="p">)</span> 
      
        <span class="c1"># --- node manager</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;LKJC_chord&quot;</span><span class="p">,</span><span class="n">LKJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>


        <span class="c1"># --- Btk Points and decorator manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoratedModel</span><span class="p">:</span>
            <span class="c1">#Native: btkpoint LKJC append with description cgm1</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LKJC_chord&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">LKJC</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LKJC_chord&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;useLeftKJCnode&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (useLeftKJCnode) found &quot;</span><span class="p">)</span>
                <span class="n">nodeLabel</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useLeftKJCnode&quot;</span><span class="p">]</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span>
                
                <span class="c1"># construction of the btkPoint label (LKJC)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>    
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; option (useLeftKJCnode) not found : KJC from chord &quot;</span><span class="p">)</span>
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span><span class="p">)</span>
           

        <span class="c1"># --- final LKJC</span>
        <span class="n">final_LKJC</span> <span class="o">=</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="n">final_LKJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_right_thigh_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Technical Coordinate system of the right thigh. </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame               </span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical referentials</span>
<span class="sd">               - `options` (dict) - use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 
            
        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>             
            
            
        <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span>


        <span class="c1"># ---  additional markers and Update of the marker segment list</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span>        


        
        <span class="c1"># --- Construction of the technical referential  </span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>       
        
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>


        <span class="c1"># --- knee Joint centers location</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;RightThighRotation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightThighRotation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RightThighRotation defined from your vsk file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightThighRotationOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightThighRotation&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightThighRotationOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">RKJC</span> <span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">chord</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightKneeWidth&quot;</span><span class="p">]</span><span class="o">+</span> <span class="n">markerDiameter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt3</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightThighRotationOffset&quot;</span><span class="p">]</span> <span class="p">)</span> <span class="c1"># could consider a previous offset</span>

        <span class="c1"># --- node manager</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;RKJC_chord&quot;</span><span class="p">,</span><span class="n">RKJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>
      
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>



        <span class="c1"># --- Btk Points and decorator manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoratedModel</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RKJC_chord&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">RKJC</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RKJC_chord&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;useRightKJCnode&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (useRightKJCnode) found &quot;</span><span class="p">)</span>

                <span class="n">nodeLabel</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useRightKJCnode&quot;</span><span class="p">]</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span>
                                                          
                <span class="c1"># construction of the btkPoint label (LKJC)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>    
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; option (useRightKJCnode) not found : KJC from chord &quot;</span><span class="p">)</span>
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span><span class="p">)</span>
           

        <span class="c1"># --- final KJC</span>
        <span class="n">final_RKJC</span> <span class="o">=</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="n">final_RKJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">_left_shank_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Technical Coordinate system of the left shank. </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame               </span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical referentials</span>
<span class="sd">               - `options` (dict) - use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span>
            
        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>             
            
        
        <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span>
        
        <span class="c1"># ---  additional markers and Update of the marker segment list</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">)</span>

        <span class="c1"># --- Construction of the technical referential  </span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>

        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>


        <span class="c1"># --- ankle Joint centers location</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;LeftShankRotation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftShankRotation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LeftShankRotation defined from your vsk file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftShankRotationOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftShankRotation&quot;</span><span class="p">]</span><span class="o">*-</span><span class="mf">1.0</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftShankRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
            
        <span class="n">LAJC</span> <span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">chord</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftAnkleWidth&quot;</span><span class="p">]</span><span class="o">+</span> <span class="n">markerDiameter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftShankRotationOffset&quot;</span><span class="p">]</span> <span class="p">)</span>

        <span class="c1"># --- node manager</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;LAJC_chord&quot;</span><span class="p">,</span><span class="n">LAJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>



        <span class="c1"># --- Btk Points and decorator manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoratedModel</span><span class="p">:</span>
            <span class="c1">#btkpoint LAJC append with description cgm1</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LAJC_chord&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">LAJC</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LAJC_chord&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;useLeftAJCnode&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (useLeftAJCnode) found &quot;</span><span class="p">)</span>
                
                <span class="n">nodeLabel</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useLeftAJCnode&quot;</span><span class="p">]</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span>

                <span class="c1"># construction of the btkPoint label (LAJC)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>    
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; option (useLeftAJCnode) not found : AJC from chord &quot;</span><span class="p">)</span>
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span><span class="p">)</span>
           

        <span class="c1"># --- final AJC</span>
        <span class="n">final_LAJC</span> <span class="o">=</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LAJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="n">final_LAJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;LAJC&quot;</span><span class="p">)</span>

        

    <span class="k">def</span> <span class="nf">_right_shank_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Technical Coordinate system of the right shank. </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame               </span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical referentials</span>
<span class="sd">               - `options` (dict) - use to pass options</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        
        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 

        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>             
            
        
        
        <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span>

        <span class="c1"># ---  additional markers and Update of the marker segment list</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">)</span>

        <span class="c1"># --- Construction of the technical Referential</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- ankle Joint centers location</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;RightShankRotation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightShankRotation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RightShankRotation defined from your vsk file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightShankRotationOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightShankRotation&quot;</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightShankRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>

        <span class="n">RAJC</span> <span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">chord</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightAnkleWidth&quot;</span><span class="p">]</span><span class="o">+</span> <span class="n">markerDiameter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightShankRotationOffset&quot;</span><span class="p">]</span> <span class="p">)</span>

        <span class="c1"># --- node manager</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;RAJC_chord&quot;</span><span class="p">,</span><span class="n">RAJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

       <span class="c1">#Btk Points and decorator manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoratedModel</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RAJC_chord&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">RAJC</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RAJC_chord&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;useRightAJCnode&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (useRightAJCnode) found &quot;</span><span class="p">)</span>
                <span class="n">nodeLabel</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useRightAJCnode&quot;</span><span class="p">]</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">setDescription</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span>
     
                <span class="c1"># construction of the btkPoint label (RAJC)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>    
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="s2">&quot;option (useRightAJCnode) not found : AJC from chord&quot;</span> <span class="p">)</span>
                <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aquiStatic</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span><span class="p">)</span>
           

        <span class="c1"># --- Final AJC</span>
        <span class="n">final_RAJC</span> <span class="o">=</span> <span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RAJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="n">final_RAJC</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;RAJC&quot;</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">_left_unCorrectedFoot_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Technical Coordinate system of the left Foot. </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame               </span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical referentials</span>
<span class="sd">               - `options` (dict) - use to pass options</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">            .. warning:: Need shank anatomical Coordinate system</span>

<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">)</span>
        
        <span class="c1"># ---  additional markers and Update of the marker segment list</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="s2">&quot;useBodyBuilderFoot&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useBodyBuilderFoot&quot;</span><span class="p">]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You use a Left uncorrected foot sequence different than native CGM1&quot;</span><span class="p">)</span>
            <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZYX&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;LTOE&quot;</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">]}</span> <span class="p">}</span> <span class="c1"># uncorrected Foot - use shank flexion axis (Y) as second axis</span>


        <span class="c1"># --- Construction of the technical Referential</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>

        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="c1">#LTOE</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="c1">#AJC</span>
        
        <span class="k">if</span> <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span> <span class="c1">#(pt3-pt1) </span>

    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_right_unCorrectedFoot_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Technical Coordinate system of the right Foot.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame               </span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical referentials</span>
<span class="sd">               - `options` (dict) - use to pass options</span>
<span class="sd">        </span>
<span class="sd">            .. note:: uncorrected foot defined a technical coordinate system of the foot </span>
<span class="sd">        </span>
<span class="sd">            .. warning:: Need shank anatomical Coordinate system</span>

<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">)</span>
        
        <span class="c1"># ---  additional markers and Update of the marker segment list</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">addMarkerLabel</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;useBodyBuilderFoot&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useBodyBuilderFoot&quot;</span><span class="p">]:</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You use a right uncorrected foot sequence different than native CGM1&quot;</span><span class="p">)</span>
            <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TF&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZYX&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>   <span class="p">[</span><span class="s2">&quot;RTOE&quot;</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">]}</span> <span class="p">}</span> <span class="c1"># uncorrected Foot - use shank flexion axis (Y) as second axis</span>



        <span class="c1"># --- Construction of the anatomical Referential</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>

        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span> <span class="c1">#(pt3-pt1)         </span>
        
        
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>
    
    <span class="c1"># ---- Anatomical Referential Calibration -------</span>

    <span class="k">def</span> <span class="nf">_pelvis_Anatomicalcalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the pelvis.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">                </span>

<span class="sd">        &quot;&quot;&quot;</span>        
        


        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">)</span>
        
        
        <span class="c1"># --- Construction of the anatomical Referential</span>
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()))</span>
                
        <span class="c1"># --- node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_left_thigh_Anatomicalcalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the left thigh.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">                </span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>              
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span>
        
        <span class="c1"># --- Construction of the anatomical Referential</span>
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>


        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()))</span>

        
        <span class="c1"># --- node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="c1"># --- compute length</span>
        <span class="n">hjc</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">kjc</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>

        <span class="n">seg</span><span class="o">.</span><span class="n">setLength</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">kjc</span><span class="o">-</span><span class="n">hjc</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_right_thigh_Anatomicalcalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the right thigh.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">        &quot;&quot;&quot;</span>             
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span>
        
        <span class="c1"># --- Construction of the anatomical Referential</span>
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()))</span>

        <span class="c1"># --- node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="c1"># --- compute lenght</span>
        <span class="n">hjc</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">kjc</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>

        <span class="n">seg</span><span class="o">.</span><span class="n">setLength</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">kjc</span><span class="o">-</span><span class="n">hjc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_left_shank_Anatomicalcalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the left shank.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">        &quot;&quot;&quot;</span>            
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span>
        
        <span class="c1"># --- Construction of the anatomical Referential</span>
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()))</span>

        <span class="c1"># --- Node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="c1"># --- compute length</span>
        <span class="n">kjc</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">ajc</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LAJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>

        <span class="n">seg</span><span class="o">.</span><span class="n">setLength</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ajc</span><span class="o">-</span><span class="n">kjc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_left_shankProximal_AnatomicalCalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the left proximal shank.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_useLeftTibialTorsion</span><span class="p">:</span>
            <span class="n">tibialTorsion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsionOffset&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tibialTorsion</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank Proximal&quot;</span><span class="p">)</span>

        
        <span class="c1"># --- set static anatomical Referential  </span>
        <span class="c1"># Rotation of the static anatomical Referential by the tibial Torsion angle </span>
        <span class="n">rotZ_tibRot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span> 
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
          
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span><span class="n">rotZ_tibRot</span><span class="p">)</span>
       
        <span class="c1"># update frame   </span>
        <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>  
        <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">())</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">setStaticFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()))</span>

        
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_right_shank_Anatomicalcalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the right shank.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">        &quot;&quot;&quot;</span>              
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span>
        
        <span class="c1"># --- Construction of the anatomical Referential</span>
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()))</span> 

        <span class="c1"># --- node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>


        <span class="c1"># --- compute length</span>
        <span class="n">kjc</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">ajc</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RAJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">setLength</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ajc</span><span class="o">-</span><span class="n">kjc</span><span class="p">))</span>
 

    <span class="k">def</span> <span class="nf">_right_shankProximal_AnatomicalCalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the right proximal shank.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_useRightTibialTorsion</span><span class="p">:</span>
            <span class="n">tibialTorsion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsionOffset&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tibialTorsion</span> <span class="o">=</span> <span class="mf">0.0</span>        


        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank Proximal&quot;</span><span class="p">)</span>

        <span class="c1"># --- set static anatomical Referential  </span>
        <span class="c1"># Rotation of the static anatomical Referential by the tibial Torsion angle</span>
        <span class="n">rotZ_tibRot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span> 
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
          
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span><span class="n">rotZ_tibRot</span><span class="p">)</span>
       
        <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>  
        <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">setStaticFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()))</span>

        <span class="c1"># node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_left_foot_corrected_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the left foot.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">               - `options` (dict) - use to pass options</span>
<span class="sd">        &quot;&quot;&quot;</span>
             
        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 

        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>             
            

        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s2">&quot;useBodyBuilderFoot&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useBodyBuilderFoot&quot;</span><span class="p">]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You use a Left corrected foot sequence different than native CGM1&quot;</span><span class="p">)</span>
            <span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZYX&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;LTOE&quot;</span><span class="p">,</span><span class="s2">&quot;LHEE&quot;</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">]}</span>    <span class="c1"># corrected foot      </span>
            
        
        <span class="c1"># --- Construction of the anatomical Referential</span>
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># LTOE</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
              
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;leftFlatFoot&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;leftFlatFoot&quot;</span><span class="p">]):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span> <span class="p">(</span><span class="s2">&quot;option (leftFlatFoot) enable&quot;</span><span class="p">)</span>            
            <span class="n">pt2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    
    
        <span class="k">if</span> <span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span> <span class="c1">#(pt3-pt1)         </span>
    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                                                       
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="c1"># This section compute the actual Relative Rotation between anatomical and technical Referential  </span>
        <span class="n">trueRelativeMatrixAnatomic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())</span>
        <span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">ceuler</span><span class="o">.</span><span class="n">euler_yxz</span><span class="p">(</span><span class="n">trueRelativeMatrixAnatomic</span><span class="p">)</span>

        <span class="c1"># the native CGM relative rotation leaves out the rotation around Z  </span>
        <span class="n">rotX</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span>
                         <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)]])</span> 
        <span class="n">rotY</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">)]])</span> 

        <span class="n">relativeMatrixAnatomic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotY</span><span class="p">,</span><span class="n">rotX</span><span class="p">)</span>
          
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span> <span class="n">relativeMatrixAnatomic</span><span class="p">)</span> 

        <span class="c1"># --- node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="c1"># --- compute amthropo</span>
        <span class="c1"># length</span>
        <span class="n">toe</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LTOE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">hee</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LHEE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">setLength</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">toe</span><span class="o">-</span><span class="n">hee</span><span class="p">)</span><span class="o">-</span> <span class="n">markerDiameter</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                
        <span class="c1"># com</span>
        <span class="n">toe</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LTOE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
        <span class="n">hee</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LHEE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
        <span class="n">footLongAxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">toe</span><span class="o">-</span><span class="n">hee</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">toe</span><span class="o">-</span><span class="n">hee</span><span class="p">)</span>
        
        <span class="n">com</span> <span class="o">=</span> <span class="n">hee</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_bsp</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">footLongAxis</span>
        
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;com&quot;</span><span class="p">,</span><span class="n">com</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_foot_corrected_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aquiStatic</span><span class="p">,</span> <span class="n">dictAnatomic</span><span class="p">,</span><span class="n">frameInit</span><span class="p">,</span><span class="n">frameEnd</span><span class="p">,</span><span class="n">options</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Construct the Anatomical Coordinate system of the right foot.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aquiStatic` (btkAcquisition) - btkAcquisition instance from a static c3d</span>
<span class="sd">               - `dictAnatomic` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>
<span class="sd">               - `frameInit` (dict) - first frame</span>
<span class="sd">               - `frameEnd` (dict) - end frame</span>
<span class="sd">               - `options` (dict) - use to pass options</span>
<span class="sd">        &quot;&quot;&quot;</span>             
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;useBodyBuilderFoot&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;useBodyBuilderFoot&quot;</span><span class="p">]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You use a Right corrected foot sequence different than native CGM1&quot;</span><span class="p">)</span>
            <span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="s2">&quot;ZYX&quot;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s2">&quot;RTOE&quot;</span><span class="p">,</span><span class="s2">&quot;RHEE&quot;</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">]}</span>    <span class="c1"># corrected foot</span>

        <span class="c1"># --- Construction of the anatomical Referential</span>
        <span class="n">pt1</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pt2</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#pt3=aquiStatic.GetPoint(str(dictAnatomic[&quot;Right Foot&quot;][&#39;labels&#39;][2])).GetValues()[frameInit:frameEnd,:].mean(axis=0)</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;rightFlatFoot&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;rightFlatFoot&quot;</span><span class="p">]):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span> <span class="p">(</span><span class="s2">&quot;option (rightFlatFoot) enable&quot;</span><span class="p">)</span>
            <span class="n">pt2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    

        <span class="k">if</span> <span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span> <span class="c1">#(pt3-pt1)</span>

    
        <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnatomic</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>          
           
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

        <span class="c1"># --- relative rotation Technical Anatomical</span>
        <span class="n">tf</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span>
        <span class="c1"># actual Relative Rotation </span>
        <span class="n">trueRelativeMatrixAnatomic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())</span>
        <span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">ceuler</span><span class="o">.</span><span class="n">euler_yxz</span><span class="p">(</span><span class="n">trueRelativeMatrixAnatomic</span><span class="p">)</span>

        <span class="c1"># native CGM relative rotation </span>
        <span class="n">rotX</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span>
                         <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)]])</span> 

        <span class="n">rotY</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">)]])</span> 

        <span class="n">relativeMatrixAnatomic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotY</span><span class="p">,</span><span class="n">rotX</span><span class="p">)</span>
          
        <span class="n">tf</span><span class="o">.</span><span class="n">setRelativeMatrixAnatomic</span><span class="p">(</span><span class="n">relativeMatrixAnatomic</span><span class="p">)</span> 

        <span class="c1"># --- node manager</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_markerLabels</span><span class="p">:</span>
            <span class="n">globalPosition</span><span class="o">=</span><span class="n">aquiStatic</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">frameInit</span><span class="p">:</span><span class="n">frameEnd</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>       
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">globalPosition</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

        <span class="c1"># --- anthropo</span>
        <span class="c1"># length</span>
        <span class="n">toe</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RTOE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">hee</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RHEE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">setLength</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">toe</span><span class="o">-</span><span class="n">hee</span><span class="p">))</span>
        
        <span class="c1"># com</span>
        <span class="n">toe</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RTOE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
        <span class="n">hee</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RHEE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
        <span class="n">com</span> <span class="o">=</span> <span class="p">(</span><span class="n">toe</span><span class="o">+</span><span class="n">hee</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
        
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">addNode</span><span class="p">(</span><span class="s2">&quot;com&quot;</span><span class="p">,</span><span class="n">com</span><span class="p">,</span><span class="n">positionType</span><span class="o">=</span><span class="s2">&quot;Global&quot;</span><span class="p">)</span>

    <span class="c1"># ---- Offsets -------</span>
    
<div class="viewcode-block" id="CGM1ModelInf.getThighOffset"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getThighOffset">[docs]</a>    <span class="k">def</span> <span class="nf">getThighOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">side</span><span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get Thigh offset. Angle between the projection of the lateral thigh marker and the knee flexion axis</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span><span class="o">==</span><span class="s2">&quot;left&quot;</span><span class="p">:</span>
            
            <span class="c1"># Left --------        </span>
            <span class="n">kneeFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
            
            
            <span class="n">proj_kneeFlexionAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">kneeFlexionAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">kneeFlexionAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="mi">0</span><span class="p">])</span> 
            <span class="n">v_kneeFlexionAxis</span> <span class="o">=</span> <span class="n">proj_kneeFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_kneeFlexionAxis</span><span class="p">)</span>  
    
    
            <span class="n">thiLocal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LTHI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
            <span class="n">proj_thi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">thiLocal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">thiLocal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="mi">0</span><span class="p">])</span>                                 
            <span class="n">v_thi</span> <span class="o">=</span> <span class="n">proj_thi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_thi</span><span class="p">)</span>
            
            <span class="n">angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_kneeFlexionAxis</span><span class="p">,</span> <span class="n">v_thi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="p">))</span>    

            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftThighRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="n">angle</span> <span class="c1"># angle needed : Thi toward knee flexion</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; left Thigh Offset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftThighRotationOffset&quot;</span><span class="p">]))</span>
            

        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span><span class="o">==</span><span class="s2">&quot;right&quot;</span><span class="p">:</span>

       
            <span class="n">kneeFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
            
            
            <span class="n">proj_kneeFlexionAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">kneeFlexionAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">kneeFlexionAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="mi">0</span><span class="p">])</span> 
            <span class="n">v_kneeFlexionAxis</span> <span class="o">=</span> <span class="n">proj_kneeFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_kneeFlexionAxis</span><span class="p">)</span>  
    
    
            <span class="n">thiLocal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RTHI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
            <span class="n">proj_thi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">thiLocal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">thiLocal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="mi">0</span><span class="p">])</span>                                 
            <span class="n">v_thi</span> <span class="o">=</span> <span class="n">proj_thi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_thi</span><span class="p">)</span>
            
            <span class="n">v_kneeFlexionAxis_opp</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">oppositeVector</span><span class="p">(</span><span class="n">v_kneeFlexionAxis</span><span class="p">)</span>         
            
            <span class="n">angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_kneeFlexionAxis_opp</span><span class="p">,</span> <span class="n">v_thi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="p">))</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightThighRotationOffset&quot;</span><span class="p">]</span><span class="o">=-</span><span class="n">angle</span> <span class="c1"># angle needed : Thi toward knee flexion</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; right Thigh Offset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightThighRotationOffset&quot;</span><span class="p">]))</span></div>
    
        

<div class="viewcode-block" id="CGM1ModelInf.getShankOffsets"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getShankOffsets">[docs]</a>    <span class="k">def</span> <span class="nf">getShankOffsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get shank offsets :</span>
<span class="sd">             </span>
<span class="sd">             - Angle between the projection of the lateral shank marker and the ankle flexion axis</span>
<span class="sd">             - Angle between the projection of the lateral ankle marker and the ankle flexion axis        </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="p">:</span>
            
            <span class="n">ankleFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
        
        
            <span class="n">proj_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">ankleFlexionAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">ankleFlexionAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">0</span><span class="p">])</span> 
                                 
            <span class="n">v_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">proj_ankleFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_ankleFlexionAxis</span><span class="p">)</span>
        
            <span class="c1">#&quot;****** left angle beetween tib and flexion axis **********&quot;    </span>
            <span class="n">tibLocal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LTIB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
            <span class="n">proj_tib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">tibLocal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">tibLocal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">0</span><span class="p">])</span>                                 
            <span class="n">v_tib</span> <span class="o">=</span> <span class="n">proj_tib</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_tib</span><span class="p">)</span>
        
            <span class="n">angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_ankleFlexionAxis</span><span class="p">,</span><span class="n">v_tib</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftShankRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="n">angle</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; left shank offset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftShankRotationOffset&quot;</span><span class="p">]))</span>
    
            
            <span class="c1">#&quot;****** left angle beetween ank and flexion axis (not used by native pig)**********&quot;        </span>
            <span class="n">ANK</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LANK&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>                    
            <span class="n">v_ank</span> <span class="o">=</span> <span class="n">ANK</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ANK</span><span class="p">)</span>            
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_ankleFlexionAxis</span><span class="p">,</span><span class="n">v_ank</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="p">))</span>
    
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;leftProjectionAngle_AnkleFlexion_LateralAnkle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
            <span class="c1">#logging.info(&quot; left projection offset =&gt; %s &quot; % str(self.mp_computed[&quot;leftProjectionAngle_AnkleFlexion_LateralAnkle&quot;]))</span>


        
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span> <span class="p">:</span>

            <span class="n">ankleFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
        
        
            <span class="n">proj_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">ankleFlexionAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">ankleFlexionAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">0</span><span class="p">])</span> 
                                 
            <span class="n">v_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">proj_ankleFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_ankleFlexionAxis</span><span class="p">)</span>
        
            <span class="c1">#&quot;****** right angle beetween tib and flexion axis **********&quot;    </span>
            <span class="n">tibLocal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RTIB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>
            <span class="n">proj_tib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">tibLocal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">tibLocal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">0</span><span class="p">])</span>
                                 
            <span class="n">v_tib</span> <span class="o">=</span> <span class="n">proj_tib</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_tib</span><span class="p">)</span>
            <span class="n">v_ankleFlexionAxis_opp</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">oppositeVector</span><span class="p">(</span><span class="n">v_ankleFlexionAxis</span><span class="p">)</span> 

        
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_ankleFlexionAxis_opp</span><span class="p">,</span><span class="n">v_tib</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightShankRotationOffset&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="n">angle</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; right shank offset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightShankRotationOffset&quot;</span><span class="p">]))</span>

            
            
            <span class="c1">#&quot;****** right angle beetween ank and flexion axis ( Not used by Native Pig)**********&quot;        </span>
            <span class="n">ANK</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RANK&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>                    
            <span class="n">v_ank</span> <span class="o">=</span> <span class="n">ANK</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ANK</span><span class="p">)</span>              
           
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_ankleFlexionAxis_opp</span><span class="p">,</span><span class="n">v_ank</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;rightProjectionAngle_AnkleFlexion_LateralAnkle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span></div>
            <span class="c1">#logging.info(&quot; right projection offset =&gt; %s &quot; % str(self.mp_computed[&quot;rightProjectionAngle_AnkleFlexion_LateralAnkle&quot;]))</span>
    

<div class="viewcode-block" id="CGM1ModelInf.getTibialTorsionOffset"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getTibialTorsionOffset">[docs]</a>    <span class="k">def</span> <span class="nf">getTibialTorsionOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get tibial torsion offset :</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="p">:</span>
            
            <span class="c1">#&quot;****** right angle beetween anatomical axis **********&quot;            </span>
            <span class="n">kneeFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
        
        
            <span class="n">proj_kneeFlexionAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">kneeFlexionAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">kneeFlexionAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">0</span><span class="p">])</span> 
            
            <span class="n">v_kneeFlexionAxis</span><span class="o">=</span> <span class="n">proj_kneeFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_kneeFlexionAxis</span><span class="p">)</span>
            
            <span class="n">ankleFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
        
        
            <span class="n">proj_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">ankleFlexionAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">ankleFlexionAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">0</span><span class="p">])</span> 
                                 
            <span class="n">v_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">proj_ankleFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_ankleFlexionAxis</span><span class="p">)</span>
                        
            <span class="n">angle</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span> <span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_kneeFlexionAxis</span><span class="p">,</span><span class="n">v_ankleFlexionAxis</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsionOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; left tibial torsion =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsionOffset&quot;</span><span class="p">]))</span>
                    
        
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span> <span class="p">:</span>
            
            <span class="c1">#&quot;****** right angle beetween anatomical axis **********&quot;            </span>
            <span class="n">kneeFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
        
        
            <span class="n">proj_kneeFlexionAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">kneeFlexionAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">kneeFlexionAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">0</span><span class="p">])</span> 
            
            <span class="n">v_kneeFlexionAxis</span><span class="o">=</span> <span class="n">proj_kneeFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_kneeFlexionAxis</span><span class="p">)</span>
            
            <span class="n">ankleFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
        
        
            <span class="n">proj_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">ankleFlexionAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">ankleFlexionAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">0</span><span class="p">])</span> 
                                 
            <span class="n">v_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">proj_ankleFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proj_ankleFlexionAxis</span><span class="p">)</span>
        
            
            <span class="n">angle</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_kneeFlexionAxis</span><span class="p">,</span><span class="n">v_ankleFlexionAxis</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisZ</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsionOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; Right tibial torsion =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsionOffset&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="CGM1ModelInf.getAbdAddAnkleJointOffset"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getAbdAddAnkleJointOffset">[docs]</a>    <span class="k">def</span> <span class="nf">getAbdAddAnkleJointOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get Abd/Add ankle offset : angle n the frontal plan between the ankle marker and the ankle flexion axis              </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="p">:</span>        
        
            <span class="n">ankleFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
        

                                 
            <span class="n">v_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">ankleFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ankleFlexionAxis</span><span class="p">)</span>
            
            <span class="n">ANK</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LANK&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span> <span class="o">-</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;LAJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>              
            <span class="n">v_ank</span> <span class="o">=</span> <span class="n">ANK</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ANK</span><span class="p">)</span>
            
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_ankleFlexionAxis</span><span class="p">,</span><span class="n">v_ank</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftAnkleAbAddOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; LeftAnkleAbAddOffset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftAnkleAbAddOffset&quot;</span><span class="p">]))</span>
            

        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span> <span class="p">:</span> 
            <span class="n">ankleFlexionAxis</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisY</span><span class="p">)</span>
        
                                 
            <span class="n">v_ankleFlexionAxis</span> <span class="o">=</span> <span class="n">ankleFlexionAxis</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ankleFlexionAxis</span><span class="p">)</span>
            
            <span class="n">v_ankleFlexionAxis_opp</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">oppositeVector</span><span class="p">(</span><span class="n">v_ankleFlexionAxis</span><span class="p">)</span>
            <span class="n">ANK</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RANK&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span> <span class="o">-</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="s2">&quot;RAJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">m_local</span>                     
            <span class="n">v_ank</span> <span class="o">=</span> <span class="n">ANK</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ANK</span><span class="p">)</span>
           
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">angleFrom2Vectors</span><span class="p">(</span><span class="n">v_ankleFlexionAxis_opp</span><span class="p">,</span><span class="n">v_ank</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">m_axisX</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightAnkleAbAddOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; RightAnkleAbAddOffset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightAnkleAbAddOffset&quot;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="CGM1ModelInf.getFootOffset"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getFootOffset">[docs]</a>    <span class="k">def</span> <span class="nf">getFootOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get foot offsets : </span>
<span class="sd">            </span>
<span class="sd">              -  plantar flexion offset              </span>
<span class="sd">              -  rotation offset</span>
<span class="sd">              </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="p">:</span>      
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span>
            <span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">ceuler</span><span class="o">.</span><span class="n">euler_yxz</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftStaticPlantFlexOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; LeftStaticPlantFlexOffset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftStaticPlantFlexOffset&quot;</span><span class="p">]))</span> 

            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftStaticRotOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; LeftStaticRotOffset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftStaticRotOffset&quot;</span><span class="p">]))</span>

        
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="ow">or</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span> <span class="p">:</span>      
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span>
            <span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">ceuler</span><span class="o">.</span><span class="n">euler_yxz</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>    
            
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightStaticPlantFlexOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; RightStaticPlantFlexOffset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightStaticPlantFlexOffset&quot;</span><span class="p">]))</span> 
            
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightStaticRotOffset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; RightStaticRotOffset =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightStaticRotOffset&quot;</span><span class="p">]))</span> </div>


<div class="viewcode-block" id="CGM1ModelInf.getViconFootOffset"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getViconFootOffset">[docs]</a>    <span class="k">def</span> <span class="nf">getViconFootOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get vicon compatible foot offsets : </span>
<span class="sd">                          </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>

<span class="sd">            .. note:  standard vicon CGM consider positive = dorsiflexion  and  abduction</span>

<span class="sd">        &quot;&quot;&quot;</span>        
        
        <span class="n">spf_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftStaticPlantFlexOffset&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Left staticPlantarFlexion offset (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">spf_l</span><span class="p">))</span>
        
        
        <span class="n">sro_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftStaticRotOffset&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Left staticRotation offset (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sro_l</span><span class="p">))</span>

        
        <span class="n">spf_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightStaticPlantFlexOffset&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Right staticRotation offset (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">spf_r</span><span class="p">))</span>
       
        <span class="n">sro_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightStaticRotOffset&quot;</span><span class="p">]</span> 
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Right staticRotation offset (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sro_r</span><span class="p">))</span>        

        <span class="k">return</span> <span class="n">spf_l</span><span class="p">,</span><span class="n">sro_l</span><span class="p">,</span><span class="n">spf_r</span><span class="p">,</span><span class="n">sro_r</span></div>


<div class="viewcode-block" id="CGM1ModelInf.getViconThighOffset"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getViconThighOffset">[docs]</a>    <span class="k">def</span> <span class="nf">getViconThighOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get vicon compatible thigh offset </span>
<span class="sd">                          </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>

<span class="sd">            .. note:  standard vicon CGM consider positive = internal rotation</span>

<span class="sd">        &quot;&quot;&quot;</span> 


        <span class="k">if</span> <span class="n">side</span>  <span class="o">==</span> <span class="s2">&quot;Left&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftThighRotationOffset&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Left thigh offset (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>             
            <span class="k">return</span> <span class="n">val</span>
 
        <span class="k">if</span> <span class="n">side</span>  <span class="o">==</span> <span class="s2">&quot;Right&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightThighRotationOffset&quot;</span><span class="p">]</span>            
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Right thigh offset (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>             
            <span class="k">return</span> <span class="n">val</span>        </div>
        
        
<div class="viewcode-block" id="CGM1ModelInf.getViconShankOffset"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getViconShankOffset">[docs]</a>    <span class="k">def</span> <span class="nf">getViconShankOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get vicon compatible shank offset </span>
<span class="sd">                          </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>

<span class="sd">            .. note:  standard vicon CGM consider positive = internal rotation</span>

<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="k">if</span> <span class="n">side</span>  <span class="o">==</span> <span class="s2">&quot;Left&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftShankRotationOffset&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Left shank offset (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> 
            <span class="k">return</span> <span class="n">val</span>
 
        <span class="k">if</span> <span class="n">side</span>  <span class="o">==</span> <span class="s2">&quot;Right&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightShankRotationOffset&quot;</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Right shank offset (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">val</span>         </div>

<div class="viewcode-block" id="CGM1ModelInf.getViconTibialTorsion"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.getViconTibialTorsion">[docs]</a>    <span class="k">def</span> <span class="nf">getViconTibialTorsion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get vicon compatible tibial tosion offset </span>
<span class="sd">                          </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `side` (str) - body side  (both, left, right)    </span>

<span class="sd">            .. note:  standard vicon CGM consider positive = internal rotation</span>

<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="k">if</span> <span class="n">side</span>  <span class="o">==</span> <span class="s2">&quot;Left&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsionOffset&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Left tibial torsion (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> 
            <span class="k">return</span> <span class="n">val</span>
 
        <span class="k">if</span> <span class="n">side</span>  <span class="o">==</span> <span class="s2">&quot;Right&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsionOffset&quot;</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Right tibial torsion  (Vicon compatible)  =&gt; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">val</span></div>
    
    <span class="c1"># ----- Motion --------------</span>
<div class="viewcode-block" id="CGM1ModelInf.computeMotion"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.computeMotion">[docs]</a>    <span class="k">def</span> <span class="nf">computeMotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span> <span class="n">motionMethod</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Compute Motion of both **Technical and Anatomical** coordinate systems </span>
<span class="sd">        </span>
<span class="sd">        :Parameters:</span>
<span class="sd">        </span>
<span class="sd">           - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">           - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">           - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system           </span>
<span class="sd">           - `motionMethod` (pyCGM2.enums) - method use to compute segment pose</span>
<span class="sd">           - `options` (dict) - dictionnary use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>         
        
        

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=====================================================&quot;</span><span class="p">)</span>         
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;===================  CGM MOTION   ===================&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=====================================================&quot;</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="n">motionMethod</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">motionMethod</span><span class="o">.</span><span class="n">Native</span><span class="p">:</span> <span class="c1">#cmf.motionMethod.Native:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Native motion process ---&quot;</span><span class="p">)</span>
            
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Pelvis - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -------------------&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pelvis_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnat</span><span class="p">)</span>
 
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Left Thigh - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -----------------------&quot;</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">_left_thigh_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Right Thigh - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ------------------------&quot;</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">_right_thigh_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>


            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Left Shank - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -----------------------&quot;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_left_shank_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
 
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Left Shank-proximal - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --------------------------------&quot;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_left_shankProximal_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
 
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Right Shank - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ------------------------&quot;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_right_shank_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Right Shank-proximal - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ---------------------------------&quot;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_right_shankProximal_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
            
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Left foot - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ----------------------&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_left_foot_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; - Right foot - motion -&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; ----------------------&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_right_foot_motion</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

            
        
        <span class="k">if</span> <span class="n">motionMethod</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">motionMethod</span><span class="o">.</span><span class="n">Sodervisk</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Segmental Least-square motion process ---&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pelvis_motion_optimize</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">motionMethod</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_left_thigh_motion_optimize</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">motionMethod</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_right_thigh_motion_optimize</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">motionMethod</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_left_shank_motion_optimize</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">motionMethod</span><span class="p">)</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">_right_shank_motion_optimize</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">motionMethod</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Display Coordinate system ---&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; --------------------------------&quot;</span><span class="p">)</span>
    
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Pelvis&quot; , &quot;Pelvis&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">,</span><span class="s2">&quot;PELO&quot;</span><span class="p">,</span><span class="s2">&quot;PELA&quot;</span><span class="p">,</span><span class="s2">&quot;PELL&quot;</span><span class="p">,</span><span class="s2">&quot;PELP&quot;</span><span class="p">)</span>
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Left Thigh&quot; , &quot;LThigh&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">,</span><span class="s2">&quot;LFEO&quot;</span><span class="p">,</span><span class="s2">&quot;LFEA&quot;</span><span class="p">,</span><span class="s2">&quot;LFEL&quot;</span><span class="p">,</span><span class="s2">&quot;LFEP&quot;</span><span class="p">)</span>
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Right Thigh&quot; , &quot;RThigh&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">,</span><span class="s2">&quot;RFEO&quot;</span><span class="p">,</span><span class="s2">&quot;RFEA&quot;</span><span class="p">,</span><span class="s2">&quot;RFEL&quot;</span><span class="p">,</span><span class="s2">&quot;RFEP&quot;</span><span class="p">)</span>
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Left Shank&quot; , &quot;LShank&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">,</span><span class="s2">&quot;LTIO&quot;</span><span class="p">,</span><span class="s2">&quot;LTIA&quot;</span><span class="p">,</span><span class="s2">&quot;LTIL&quot;</span><span class="p">,</span><span class="s2">&quot;LTIP&quot;</span><span class="p">)</span>
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Left Shank Proximal&quot; , &quot;LShankProx&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Left Shank Proximal&quot;</span><span class="p">,</span><span class="s2">&quot;LTPO&quot;</span><span class="p">,</span><span class="s2">&quot;LTPA&quot;</span><span class="p">,</span><span class="s2">&quot;LTPL&quot;</span><span class="p">,</span><span class="s2">&quot;LTPP&quot;</span><span class="p">)</span>
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Right Shank&quot; , &quot;RShank&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">,</span><span class="s2">&quot;RTIO&quot;</span><span class="p">,</span><span class="s2">&quot;RTIA&quot;</span><span class="p">,</span><span class="s2">&quot;RTIL&quot;</span><span class="p">,</span><span class="s2">&quot;RTIP&quot;</span><span class="p">)</span>
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Right Shank Proximal&quot; , &quot;RShankProx&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Right Shank Proximal&quot;</span><span class="p">,</span><span class="s2">&quot;RTPO&quot;</span><span class="p">,</span><span class="s2">&quot;RTPA&quot;</span><span class="p">,</span><span class="s2">&quot;RTPL&quot;</span><span class="p">,</span><span class="s2">&quot;RTPP&quot;</span><span class="p">)</span>
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Left Foot&quot; , &quot;LFoot&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">,</span><span class="s2">&quot;LFOO&quot;</span><span class="p">,</span><span class="s2">&quot;LFOA&quot;</span><span class="p">,</span><span class="s2">&quot;LFOL&quot;</span><span class="p">,</span><span class="s2">&quot;LFOP&quot;</span><span class="p">)</span> 
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Right Foot&quot; , &quot;RFoot&quot; )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayMotionViconCoordinateSystem</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">,</span><span class="s2">&quot;RFOO&quot;</span><span class="p">,</span><span class="s2">&quot;RFOA&quot;</span><span class="p">,</span><span class="s2">&quot;RFOL&quot;</span><span class="p">,</span><span class="s2">&quot;RFOP&quot;</span><span class="p">)</span> </div>
        
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Left Foot&quot; , &quot;LFootUncorrected&quot;,referential=&quot;technical&quot;) </span>
        <span class="c1">#self.displayMotionCoordinateSystem( aqui,  &quot;Right Foot&quot; , &quot;RFootUncorrected&quot;,referential=&quot;technical&quot;) </span>
    <span class="c1"># ----- native motion ------</span>

    

    <span class="k">def</span> <span class="nf">_pelvis_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the pelvis</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system </span>

<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">)</span>

        <span class="c1"># --- motion of the technical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>        <span class="c1"># reinit Technical Frame Motion (USEFUL if you work with several aquisitions)</span>

        <span class="c1">#  additional markers </span>
        <span class="n">val</span><span class="o">=</span><span class="p">(</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LPSI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span> <span class="o">+</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RPSI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>        
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;SACR&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
         
        <span class="n">val</span><span class="o">=</span><span class="p">(</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LASI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span> <span class="o">+</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RASI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>        
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;midASIS&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># --- HJCs </span>
        <span class="n">values_LHJCnode</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getNodeTrajectory</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span>
        <span class="n">values_RHJCnode</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getNodeTrajectory</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span>

        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;LHJC&quot;</span><span class="p">,</span><span class="n">values_LHJCnode</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;RHJC&quot;</span><span class="p">,</span><span class="n">values_RHJCnode</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;cgm1&quot;</span><span class="p">)</span>


        <span class="c1"># --- motion of the anatomical referential</span>

        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers         </span>
        <span class="n">val</span><span class="o">=</span><span class="p">(</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span> <span class="o">+</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>        
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;midHJC&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_left_thigh_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the left thigh</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 

        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>  
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span>


        <span class="c1"># --- motion of the technical referential                   </span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>   <span class="c1"># reinit Technical Frame Motion ()</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="n">LKJCvalues</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>                   
                   
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            <span class="n">LKJCvalues</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">chord</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftKneeWidth&quot;</span><span class="p">]</span><span class="o">+</span> <span class="n">markerDiameter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftThighRotationOffset&quot;</span><span class="p">]</span> <span class="p">)</span>
            
            
        <span class="c1"># --- LKJC     </span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="n">LKJCvalues</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span><span class="p">)</span>

        <span class="c1"># --- motion of the anatomical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation        </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>



     


    <span class="k">def</span> <span class="nf">_right_thigh_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the right thigh</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>          
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 

        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>  
            
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span>
        
        <span class="c1"># --- motion of the technical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>
        
        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation           </span>
        <span class="n">RKJCvalues</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>                   
                   
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            <span class="n">RKJCvalues</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">chord</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightKneeWidth&quot;</span><span class="p">]</span><span class="o">+</span> <span class="n">markerDiameter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightThighRotationOffset&quot;</span><span class="p">]</span> <span class="p">)</span>
            
            
        <span class="c1"># --- RKJC    </span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="n">RKJCvalues</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span><span class="p">)</span>

        <span class="c1"># --- motion of the anatomical referential</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>        
        

    


    <span class="k">def</span> <span class="nf">_left_shank_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the left shank</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 

        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>  
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span>
                   
        <span class="c1"># --- motion of the technical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="n">LAJCvalues</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>                   
                   
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>


            <span class="n">LAJCvalues</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">chord</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;LeftAnkleWidth&quot;</span><span class="p">]</span><span class="o">+</span> <span class="n">markerDiameter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftShankRotationOffset&quot;</span><span class="p">]</span> <span class="p">)</span>
                
            <span class="c1"># update of the AJC location with rotation around abdAddAxis </span>
            <span class="n">LAJCvalues</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotateAjc</span><span class="p">(</span><span class="n">LAJCvalues</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftAnkleAbAddOffset&quot;</span><span class="p">])</span>
            

        <span class="c1"># --- LAJC</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftAnkleAbAddOffset&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord+AbAdRot&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span>
            
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="n">LAJCvalues</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>

        <span class="c1"># --- motion of the anatomical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>        

    <span class="k">def</span> <span class="nf">_left_shankProximal_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the left proximal shank</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span>
        <span class="n">segProx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank Proximal&quot;</span><span class="p">)</span>


        <span class="c1"># --- managment of tibial torsion    </span>
        <span class="k">if</span> <span class="s2">&quot;useLeftTibialTorsion&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;option (useLeftTibialTorsion) enable&quot;</span><span class="p">)</span>
            <span class="n">tibialTorsion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;LeftTibialTorsionOffset&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;option (useLeftTibialTorsion) disable&quot;</span><span class="p">)</span>
            <span class="n">tibialTorsion</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#np.deg2rad(self.mp_computed[&quot;leftTibialTorsion&quot;])</span>


        <span class="c1"># --- motion of both technical and anatomical referentials of the proximal shank</span>
        <span class="n">segProx</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>
        <span class="n">segProx</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="n">rotZ_tibRot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span> 
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
          
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> 

            <span class="n">segProx</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># copy technical shank</span>

            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span><span class="n">rotZ_tibRot</span><span class="p">)</span> <span class="c1"># affect Tibial torsion to anatomical shank</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>  
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>              
            <span class="n">segProx</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    
    <span class="k">def</span> <span class="nf">_right_shank_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the right shank</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="s2">&quot;markerDiameter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (markerDiameter) found &quot;</span><span class="p">)</span>
            <span class="n">markerDiameter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;markerDiameter&quot;</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markerDiameter</span><span class="o">=</span><span class="mf">14.0</span> 

        <span class="k">if</span> <span class="s2">&quot;basePlate&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; option (basePlate) found &quot;</span><span class="p">)</span>
            <span class="n">basePlate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basePlate&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basePlate</span><span class="o">=</span><span class="mf">2.0</span>  
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span>

        
        <span class="c1"># --- motion of the technical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="n">RAJCvalues</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>                   
                   
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> <span class="c1">#ank</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> <span class="c1">#kjc</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> <span class="c1">#tib</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>
            
            <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            <span class="c1"># ajc position from chord modified by shank offset </span>
            <span class="n">RAJCvalues</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">CGM</span><span class="o">.</span><span class="n">chord</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="s2">&quot;RightAnkleWidth&quot;</span><span class="p">]</span><span class="o">+</span> <span class="n">markerDiameter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="p">,</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt3</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightShankRotationOffset&quot;</span><span class="p">]</span> <span class="p">)</span>

            <span class="c1"># update of the AJC location with rotation around abdAddAxis </span>
            <span class="n">RAJCvalues</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotateAjc</span><span class="p">(</span><span class="n">RAJCvalues</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">pt2</span><span class="p">,</span><span class="n">pt1</span><span class="p">,</span>   <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightAnkleAbAddOffset&quot;</span><span class="p">])</span> 

        <span class="c1"># --- RAJC</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightAnkleAbAddOffset&quot;</span><span class="p">]</span> <span class="o">&gt;</span><span class="mf">0.01</span><span class="p">:</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord+AbAdRot&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span>
            
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="n">RAJCvalues</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
        

        <span class="c1"># --- motion of the anatomical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                     
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>

            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_shankProximal_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the right proximal shank</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        
        
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span>
        <span class="n">segProx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank Proximal&quot;</span><span class="p">)</span>        

       
        <span class="c1"># --- management of the tibial torsion </span>
        <span class="k">if</span> <span class="s2">&quot;useRightTibialTorsion&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tibialTorsion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_computed</span><span class="p">[</span><span class="s2">&quot;RightTibialTorsionOffset&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tibialTorsion</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#np.deg2rad(self.mp_computed[&quot;leftTibialTorsion&quot;])</span>

        <span class="c1"># --- motion of both technical and anatomical referentials of the proximal shank</span>
        <span class="n">segProx</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>
        <span class="n">segProx</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="n">rotZ_tibRot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span> 
        <span class="n">rotZ_tibRot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tibialTorsion</span><span class="p">)</span>
          
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> 

            <span class="n">segProx</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># copy technical shank</span>

            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span><span class="n">rotZ_tibRot</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>  
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>              
            <span class="n">segProx</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    


    <span class="k">def</span> <span class="nf">_left_foot_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the left foot</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">)</span>

        <span class="c1"># --- motion of the technical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> <span class="c1">#toe</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> <span class="c1">#ajc</span>
            
            <span class="k">if</span> <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;viconCGM1compatible&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank Proximal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">m_axisY</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">m_axisY</span>           
            
            
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
            
            
            
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>
            
            <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>


        <span class="c1"># --- motion of the anatomical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="c1">#R = np.dot(seg.getReferential(&quot;TF&quot;).motion[i].getRotation(),relativeSegTech )</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span> 
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_foot_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of both Technical and Anatomical coordinate systems of the right foot</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">)</span>
        

        <span class="c1"># --- motion of the technical referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>

        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation                   </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="n">pt1</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> <span class="c1">#toe</span>
            <span class="n">pt2</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span> <span class="c1">#ajc</span>
            
            <span class="k">if</span> <span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pt3</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">pt3</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;viconCGM1compatible&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank Proximal&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">m_axisY</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">m_axisY</span>              
            
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>             
         
         
            <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">pt2</span><span class="o">-</span><span class="n">pt1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
            
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    
            <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dictRef</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s2">&quot;TF&quot;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> 
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ptOrigin</span><span class="p">)</span>
            
            <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            
        <span class="c1"># --- motion of the anatomical referential</span>
        
        <span class="c1"># additional markers</span>
        <span class="c1"># NA</span>

        <span class="c1"># computation</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Foot&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="c1">#R = np.dot(seg.getReferential(&quot;TF&quot;).motion[i].getRotation(),relativeSegTech )</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span> 
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># ----- least-square Segmental motion ------</span>
    <span class="k">def</span> <span class="nf">_pelvis_motion_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span> <span class="n">motionMethod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of the anatomical coordinate system of the pelvis from rigid transformation with motion of the technical coordinate system.   </span>
<span class="sd">            Least-square optimization can be used.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">)</span>

        <span class="c1">#  --- check presence of tracking markers in the acquisition</span>
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">btkTools</span><span class="o">.</span><span class="n">isPointsExist</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">)</span>
            
        <span class="c1"># --- Motion of the Technical frame</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>
        
        <span class="c1"># part 1: get global location in Static</span>
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with tracking markers</span>
            <span class="n">staticPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>            
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                <span class="n">staticPos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>                
            
        <span class="c1"># part 2 : get dynamic position ( look out i pick up value in the btkAcquisition)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            
            <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with traking markers </span>
                <span class="n">dynPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># use </span>
                <span class="n">k</span><span class="o">=</span><span class="mi">0</span>            
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">dynPos</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span> 
            
            <span class="k">if</span> <span class="n">motionMethod</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">motionMethod</span><span class="o">.</span><span class="n">Sodervisk</span> <span class="p">:</span>
                <span class="n">Ropt</span><span class="p">,</span> <span class="n">Lopt</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">Am</span><span class="p">,</span> <span class="n">Bm</span><span class="o">=</span><span class="n">cmot</span><span class="o">.</span><span class="n">segmentalLeastSquare</span><span class="p">(</span><span class="n">staticPos</span><span class="p">,</span> 
                                                              <span class="n">dynPos</span><span class="p">)</span>
                <span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())</span>    
                <span class="n">tOri</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">())</span><span class="o">+</span><span class="n">Lopt</span>                                        
                            
                <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">tOri</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># --- HJC</span>
        <span class="n">values_LHJCnode</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getNodeTrajectory</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span>
        <span class="n">values_RHJCnode</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getNodeTrajectory</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span>

        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;LHJC&quot;</span><span class="p">,</span><span class="n">values_LHJCnode</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;opt&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;RHJC&quot;</span><span class="p">,</span><span class="n">values_RHJCnode</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;opt&quot;</span><span class="p">)</span>


        <span class="c1"># --- Motion of the Anatomical frame</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c1"># additional markers</span>
        <span class="n">val</span><span class="o">=</span><span class="p">(</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;LASI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()</span> <span class="o">+</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="s2">&quot;RASI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>        
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;midASIS&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># computation         </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Pelvis&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="c1">#R = np.dot(seg.getReferential(&quot;TF&quot;).motion[i].getRotation(),relativeSegTech )</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span> 
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_left_thigh_motion_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span> <span class="n">motionMethod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of the anatomical coordinate system of the left thigh from rigid transformation with motion of the technical coordinate system.   </span>
<span class="sd">            Least-square optimization can be used.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">)</span>

        <span class="c1">#  --- add LHJC if list &lt;2 - check presence of tracking markers in the acquisition</span>
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> 
                <span class="k">if</span> <span class="s2">&quot;LHJC&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LHJC&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LHJC added to tracking marker list&quot;</span><span class="p">)</span>
            
            <span class="n">btkTools</span><span class="o">.</span><span class="n">isPointsExist</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">)</span>

        <span class="c1"># --- Motion of the Technical frame</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>

        <span class="c1"># part 1: get back static global position ( look out i use nodes)</span>
                        
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with tracking markers</span>
            <span class="n">staticPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>            
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span> <span class="c1"># recupere les tracki</span>
                <span class="n">staticPos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>                
            
        <span class="c1"># part 2 : get dynamic position ( look out i pick up value in the btkAcquisition)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with traking markers </span>
                <span class="n">dynPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># use </span>
                <span class="n">k</span><span class="o">=</span><span class="mi">0</span>            
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">dynPos</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>             
        
        
            <span class="k">if</span> <span class="n">motionMethod</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">motionMethod</span><span class="o">.</span><span class="n">Sodervisk</span> <span class="p">:</span>
                <span class="n">Ropt</span><span class="p">,</span> <span class="n">Lopt</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">Am</span><span class="p">,</span> <span class="n">Bm</span><span class="o">=</span><span class="n">cmot</span><span class="o">.</span><span class="n">segmentalLeastSquare</span><span class="p">(</span><span class="n">staticPos</span><span class="p">,</span> 
                                                              <span class="n">dynPos</span><span class="p">)</span>
                <span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())</span>    
                <span class="n">tOri</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">())</span><span class="o">+</span><span class="n">Lopt</span>                                        
                            
                <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">tOri</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># --- LKJC</span>
        <span class="n">values_LKJCnode</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getNodeTrajectory</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;LKJC&quot;</span><span class="p">,</span><span class="n">values_LKJCnode</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;opt&quot;</span><span class="p">)</span>

        <span class="c1"># --- Motion of the Anatomical frame</span>

        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="c1">#R = np.dot(seg.getReferential(&quot;TF&quot;).motion[i].getRotation(),relativeSegTech )</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span> 
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            
            
    <span class="k">def</span> <span class="nf">_right_thigh_motion_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span> <span class="n">dictAnat</span><span class="p">,</span> <span class="n">motionMethod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of the anatomical coordinate system of the right thigh from rigid transformation with motion of the technical coordinate system.   </span>
<span class="sd">            Least-square optimization can be used.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">)</span>

        <span class="c1">#  --- add RHJC if list &lt;2 - check presence of tracking markers in the acquisition</span>
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> 
                <span class="k">if</span> <span class="s2">&quot;RHJC&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RHJC&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RHJC added to tracking marker list&quot;</span><span class="p">)</span>
            
        <span class="c1"># --- Motion of the Technical frame</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>

        <span class="c1"># part 1: get back static global position ( look ou i use nodes)</span>
                        
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with tracking markers</span>
            <span class="n">staticPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>            
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                <span class="n">staticPos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>                
            
        <span class="c1"># part 2 : get dynamic position ( look out i pick up value in the btkAcquisition)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with traking markers </span>
                <span class="n">dynPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># use </span>
                <span class="n">k</span><span class="o">=</span><span class="mi">0</span>            
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">dynPos</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>             
        
        
            <span class="k">if</span> <span class="n">motionMethod</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">motionMethod</span><span class="o">.</span><span class="n">Sodervisk</span> <span class="p">:</span>
                <span class="n">Ropt</span><span class="p">,</span> <span class="n">Lopt</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">Am</span><span class="p">,</span> <span class="n">Bm</span><span class="o">=</span><span class="n">cmot</span><span class="o">.</span><span class="n">segmentalLeastSquare</span><span class="p">(</span><span class="n">staticPos</span><span class="p">,</span> 
                                                              <span class="n">dynPos</span><span class="p">)</span>
                <span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())</span>    
                <span class="n">tOri</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">())</span><span class="o">+</span><span class="n">Lopt</span>                                        
                            
                <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">tOri</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># --- RKJC</span>
        <span class="n">values_RKJCnode</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getNodeTrajectory</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;RKJC&quot;</span><span class="p">,</span><span class="n">values_RKJCnode</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;opt&quot;</span><span class="p">)</span>


        <span class="c1"># --- Motion of the Anatomical frame</span>

        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Thigh&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="c1">#R = np.dot(seg.getReferential(&quot;TF&quot;).motion[i].getRotation(),relativeSegTech )</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span> 
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_left_shank_motion_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span>  <span class="n">motionMethod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of the anatomical coordinate system of the left shank from rigid transformation with motion of the technical coordinate system.   </span>
<span class="sd">            Least-square optimization can be used.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">)</span>
        
        <span class="c1">#  --- add LKJC if list &lt;2 - check presence of tracking markers in the acquisition</span>
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> 
                <span class="k">if</span> <span class="s2">&quot;LKJC&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LKJC&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LKJC added to tracking marker list&quot;</span><span class="p">)</span>
            
        <span class="c1"># --- Motion of the Technical frame        </span>
        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>

       <span class="c1"># part 1: get back static global position ( look ou i use nodes)</span>
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with tracking markers</span>
            <span class="n">staticPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>            
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                <span class="n">staticPos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>                
            
        <span class="c1"># part 2 : get dynamic position ( look out i pick up value in the btkAcquisition)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with traking markers </span>
                <span class="n">dynPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># use </span>
                <span class="n">k</span><span class="o">=</span><span class="mi">0</span>            
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">dynPos</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>             
        
        
            <span class="k">if</span> <span class="n">motionMethod</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">motionMethod</span><span class="o">.</span><span class="n">Sodervisk</span> <span class="p">:</span>
                <span class="n">Ropt</span><span class="p">,</span> <span class="n">Lopt</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">Am</span><span class="p">,</span> <span class="n">Bm</span><span class="o">=</span><span class="n">cmot</span><span class="o">.</span><span class="n">segmentalLeastSquare</span><span class="p">(</span><span class="n">staticPos</span><span class="p">,</span> 
                                                              <span class="n">dynPos</span><span class="p">)</span>
                <span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())</span>    
                <span class="n">tOri</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">())</span><span class="o">+</span><span class="n">Lopt</span>                                        
                            
                <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">tOri</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># --- LAJC</span>
        <span class="n">values_LAJCnode</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getNodeTrajectory</span><span class="p">(</span><span class="s2">&quot;LAJC&quot;</span><span class="p">)</span>
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;LAJC&quot;</span><span class="p">,</span><span class="n">values_LAJCnode</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;opt&quot;</span><span class="p">)</span>


        <span class="c1"># --- motion of the anatomical Referential</span>
        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Left Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span> 
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_shank_motion_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aqui</span><span class="p">,</span> <span class="n">dictRef</span><span class="p">,</span><span class="n">dictAnat</span><span class="p">,</span> <span class="n">motionMethod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Compute Motion of the anatomical coordinate system of the right shank from rigid transformation with motion of the technical coordinate system.   </span>
<span class="sd">            Least-square optimization can be used.</span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `aqui` (btkAcquisition) - acquisition instance of a dynamic trial</span>
<span class="sd">               - `dictRef` (dict) - dictionnary reporting markers and sequence use for building Technical coordinate system</span>
<span class="sd">               - `dictAnat` (dict) - dictionnary reporting markers and sequence use for building Anatomical coordinate system</span>
<span class="sd">               - `options` (dict) - dictionnary use to pass options</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSegment</span><span class="p">(</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">)</span>

        <span class="c1">#  --- add RKJC if list &lt;2 - check presence of tracking markers in the acquisition</span>
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> 
                <span class="k">if</span> <span class="s2">&quot;RKJC&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RKJC&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RKJC added to tracking marker list&quot;</span><span class="p">)</span>
            
        <span class="c1"># --- Motion of the Technical frame</span>

        <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span> <span class="o">=</span><span class="p">[]</span>

        <span class="c1"># part 1: get back static global position ( look ou i use nodes)</span>
                        
        <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with tracking markers</span>
            <span class="n">staticPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>            
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                <span class="n">staticPos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getNode_byLabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">m_global</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>                
            
        <span class="c1"># part 2 : get dynamic position ( look out i pick up value in the btkAcquisition)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>

            <span class="k">if</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># work with traking markers </span>
                <span class="n">dynPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># use </span>
                <span class="n">k</span><span class="o">=</span><span class="mi">0</span>            
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">m_tracking_markers</span><span class="p">:</span>
                    <span class="n">dynPos</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>             
        
        
            <span class="k">if</span> <span class="n">motionMethod</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">motionMethod</span><span class="o">.</span><span class="n">Sodervisk</span> <span class="p">:</span>
                <span class="n">Ropt</span><span class="p">,</span> <span class="n">Lopt</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">,</span> <span class="n">Am</span><span class="p">,</span> <span class="n">Bm</span><span class="o">=</span><span class="n">cmot</span><span class="o">.</span><span class="n">segmentalLeastSquare</span><span class="p">(</span><span class="n">staticPos</span><span class="p">,</span> 
                                                              <span class="n">dynPos</span><span class="p">)</span>
                <span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())</span>    
                <span class="n">tOri</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ropt</span><span class="p">,</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">getTranslation</span><span class="p">())</span><span class="o">+</span><span class="n">Lopt</span>                                        
                            
                <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">tOri</span><span class="p">)</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">R</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># RAJC </span>
        <span class="n">values_RAJCnode</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getNodeTrajectory</span><span class="p">(</span><span class="s2">&quot;RAJC&quot;</span><span class="p">)</span>
       
        <span class="n">btkTools</span><span class="o">.</span><span class="n">smartAppendPoint</span><span class="p">(</span><span class="n">aqui</span><span class="p">,</span><span class="s2">&quot;RAJC&quot;</span><span class="p">,</span><span class="n">values_RAJCnode</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;opt&quot;</span><span class="p">)</span>


        <span class="c1"># --- Motion of anatomical Frame </span>

        <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">motion</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPointFrameNumber</span><span class="p">()):</span>
            <span class="n">ptOrigin</span><span class="o">=</span><span class="n">aqui</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dictAnat</span><span class="p">[</span><span class="s2">&quot;Right Shank&quot;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">GetValues</span><span class="p">()[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="c1">#R = np.dot(seg.getReferential(&quot;TF&quot;).motion[i].getRotation(),relativeSegTech )</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getRotation</span><span class="p">(),</span> <span class="n">seg</span><span class="o">.</span><span class="n">getReferential</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">relativeMatrixAnatomic</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span> 
            <span class="n">frame</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">ptOrigin</span><span class="p">)</span>
            <span class="n">seg</span><span class="o">.</span><span class="n">anatomicalFrame</span><span class="o">.</span><span class="n">addMotionFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>


    <span class="c1"># ---- tools ----</span>
    <span class="k">def</span> <span class="nf">_rotateAjc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ajc</span><span class="p">,</span><span class="n">kjc</span><span class="p">,</span><span class="n">ank</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            get AJC from abd/add rotation offset </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `ajc` (numpy.array(1,3)) - global location of the ankle joint centre</span>
<span class="sd">               - `kjc` (numpy.array(1,3)) - global location of the knee joint centre</span>
<span class="sd">               - `ank` (numpy.array(1,3)) - global location of the lateral ankle marker</span>
<span class="sd">               - `offset` (double) - abd/add rotation offset</span>

<span class="sd">            :return:</span>
<span class="sd">                - final location of AJC after offset rotation </span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">kjc</span><span class="o">-</span><span class="n">ajc</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
        
        <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">ank</span><span class="o">-</span><span class="n">ajc</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        
        <span class="n">a2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
        
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">setFrameData</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="s2">&quot;ZXY&quot;</span><span class="p">)</span> 
        <span class="n">frame</span><span class="o">=</span><span class="n">cfr</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>                
                
        <span class="n">frame</span><span class="o">.</span><span class="n">m_axisX</span><span class="o">=</span><span class="n">x</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">m_axisY</span><span class="o">=</span><span class="n">y</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">m_axisZ</span><span class="o">=</span><span class="n">z</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">ank</span><span class="p">)</span>

        <span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ajc</span><span class="o">-</span><span class="n">ank</span><span class="p">)</span>

        <span class="n">abAdangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> 
       
        <span class="n">rotAbdAdd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">abAdangle</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">abAdangle</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">abAdangle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">abAdangle</span><span class="p">)</span> <span class="p">]])</span>

        <span class="n">finalRot</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">rotAbdAdd</span><span class="p">)</span>
        
        <span class="k">return</span>  <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">finalRot</span><span class="p">,</span><span class="n">loc</span><span class="p">)</span><span class="o">+</span><span class="n">ank</span>

    <span class="c1"># ---- finalize methods ------</span>
        
<div class="viewcode-block" id="CGM1ModelInf.finalizeAbsoluteAngles"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.finalizeAbsoluteAngles">[docs]</a>    <span class="k">def</span> <span class="nf">finalizeAbsoluteAngles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SegmentLabel</span><span class="p">,</span><span class="n">anglesValues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finalize absolute angles for clinical interpretation   </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `SegmentLabel` (str) - label of the segment</span>
<span class="sd">               - `anglesValues` (numpy.array(:,3)) - angle values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># note from btk</span>
        <span class="c1">#  Eigen::Matrix&lt;double,Eigen::Dynamic,1&gt; temp = angle-&gt;GetValues().col(1);</span>
        <span class="c1">#           angle-&gt;GetValues().col(1) = angle-&gt;GetValues().col(2);</span>
        <span class="c1">#           angle-&gt;GetValues().col(2) =  -1.0 * temp;</span>

        
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">anglesValues</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">SegmentLabel</span> <span class="o">==</span> <span class="s2">&quot;Left Foot&quot;</span> <span class="p">:</span>      
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">SegmentLabel</span> <span class="o">==</span> <span class="s2">&quot;Right Foot&quot;</span> <span class="p">:</span>      
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">SegmentLabel</span> <span class="o">==</span> <span class="s2">&quot;RPelvis&quot;</span> <span class="p">:</span>       
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">SegmentLabel</span> <span class="o">==</span> <span class="s2">&quot;LPelvis&quot;</span> <span class="p">:</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">anglesValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">values</span></div>
            


<div class="viewcode-block" id="CGM1ModelInf.finalizeJCS"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.finalizeJCS">[docs]</a>    <span class="k">def</span> <span class="nf">finalizeJCS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jointLabel</span><span class="p">,</span><span class="n">jointValues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">            Finalize joint angles for clinical interpretation   </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `SegmentLabel` (str) - label of the segment</span>
<span class="sd">               - `jointValues` (numpy.array(:,3)) - angle values</span>

<span class="sd">        &quot;&quot;&quot;</span>
 
             
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">jointValues</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>        

        
        <span class="k">if</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;LHip&quot;</span> <span class="p">:</span>  <span class="c1">#LHPA=&lt;-1(LHPA),-2(LHPA),-3(LHPA)&gt; {*flexion, adduction, int. rot.			*}       </span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;LKnee&quot;</span> <span class="p">:</span> <span class="c1"># LKNA=&lt;1(LKNA),-2(LKNA),-3(LKNA)-$LTibialTorsion&gt;  {*flexion, varus, int. rot.		*}       </span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;RHip&quot;</span> <span class="p">:</span>  <span class="c1"># RHPA=&lt;-1(RHPA),2(RHPA),3(RHPA)&gt;   {*flexion, adduction, int. rot.			*}</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;RKnee&quot;</span> <span class="p">:</span> <span class="c1">#  RKNA=&lt;1(RKNA),2(RKNA),3(RKNA)-$RTibialTorsion&gt;    {*flexion, varus, int. rot.		*}  </span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;LAnkle&quot;</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">))</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>            

        <span class="k">elif</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;RAnkle&quot;</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">))</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> 

        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>     
            <span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span>  <span class="n">jointValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
            
        <span class="k">return</span> <span class="n">values</span></div>

<div class="viewcode-block" id="CGM1ModelInf.finalizeKinetics"><a class="viewcode-back" href="../../../../pyCGM2.Model.CGM2.html#pyCGM2.Model.CGM2.cgm.CGM1ModelInf.finalizeKinetics">[docs]</a>    <span class="k">def</span> <span class="nf">finalizeKinetics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jointLabel</span><span class="p">,</span><span class="n">forceValues</span><span class="p">,</span><span class="n">momentValues</span><span class="p">,</span> <span class="n">projection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finalize kinetic ouputs for clinical interpretation   </span>
<span class="sd">        </span>
<span class="sd">            :Parameters:</span>
<span class="sd">               - `jointLabel` (str) - label of the segment</span>
<span class="sd">               - `forceValues` (numpy.array(:,3)) - global joint Force</span>
<span class="sd">               - `momentValues` (numpy.array(:,3)) - global joint moment</span>
<span class="sd">               - `projection` (pyCGM2.enums) - type of projection </span>
<span class="sd">               </span>
<span class="sd">               </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">valuesF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">forceValues</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">valuesM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">momentValues</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;LAnkle&quot;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Distal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>            

            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Proximal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>  

            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Global</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

        <span class="k">if</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;LKnee&quot;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Distal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Proximal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 
               
            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Global</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                
        <span class="k">if</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;LHip&quot;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Distal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Proximal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>     
                
            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Global</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>     


        <span class="k">if</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;RAnkle&quot;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Distal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            
                
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>            

            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Proximal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>                 
                
            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Global</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>  

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>                 

        <span class="k">if</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;RKnee&quot;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Distal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Proximal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 
               
            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Global</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
                
        <span class="k">if</span> <span class="n">jointLabel</span> <span class="o">==</span> <span class="s2">&quot;RHip&quot;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Distal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Proximal</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>            

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>     
                
            <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="n">pyCGM2Enums</span><span class="o">.</span><span class="n">MomentProjection</span><span class="o">.</span><span class="n">Global</span><span class="p">:</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesF</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">forceValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">momentValues</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valuesM</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">momentValues</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 

        <span class="k">return</span> <span class="n">valuesF</span><span class="p">,</span><span class="n">valuesM</span>    </div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, Fabien Leboeuf.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>